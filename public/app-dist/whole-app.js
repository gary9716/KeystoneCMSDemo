!function(){"use strict";angular.module("mainApp",["ngAnimate","ui.router","ui.bootstrap","ngCart","LocalStorageModule","ngFileUpload"]).constant("appRootPath",("production"===locals.env?locals.appRootPath="/app-min/":locals.appRootPath="/app/",locals.appRootPath)).constant("cachedFarmersKey","mainApp:cachedFarmers"),angular.module("mainApp").config(["appRootPath","$stateProvider","$urlRouterProvider","localStorageServiceProvider",function(e,t,r,a){t.state({name:"home",templateUrl:e+"home/index.html",controller:"HomeCtrler as ctrler",url:"/"}).state({name:"farmer",templateUrl:e+"farmer/index.html",url:"/farmer"}).state({name:"farmerRegister",templateUrl:e+"farmer/register.html",url:"/farmer/register",controller:"FarmerPageCtrler as ctrler",resolve:{condition1:["myValidation",function(e){return e.checkPermission([{listName:"Farmer",opName:"create"}])}]}}).state({name:"farmerSearch",templateUrl:e+"farmer/search.html",url:"/farmer/search",controller:"FarmerPageCtrler as ctrler",resolve:{condition1:["myValidation",function(e){return e.checkPermission([{listName:"Farmer",opName:"read"}])}]}}).state({name:"farmerDetail",templateUrl:e+"farmer/detail.html",url:"/farmer/detail",params:{farmerPID:null},controller:"AccountPageCtrler as ctrler",resolve:{condition1:["myValidation",function(e){return e.checkPermission([{listName:"Farmer",opName:"read"},{listName:"Account",opName:"read"},{listName:"AccountRecord",opName:"read"}])}]}}).state({name:"product",templateUrl:e+"product/index.html",url:"/product"}).state({name:"productSell",templateUrl:e+"product/sell.html",url:"/product/sell",controller:"ProductPageCtrler as ctrler",resolve:{condition1:["myValidation",function(e){return e.checkPermission([{listName:"Product",opName:"read"},{listName:"Farmer",opName:"read"},{listName:"Account",opName:["read","update"]},{listName:"AccountRecord",opName:"create"},{listName:"Transaction",opName:"create"}])}]}}).state({name:"productManage",templateUrl:e+"product/manage.html",url:"/product/manage",controller:"ProductPageCtrler as ctrler",resolve:{condition1:["myValidation",function(e){return e.checkPermission([{listName:"Product",opName:["create","read","update","delete"]},{listName:"ProductType",opName:["create","read","update","delete"]}])}]}}).state({name:"statistics",templateUrl:e+"statistics/index.html",url:"/statistics"}).state({name:"transStatisData",templateUrl:e+"statistics/transaction-list.html",url:"/statistics/transaction",controller:"TransListPageCtrler as ctrler",resolve:{condition1:["myValidation",function(e){return e.checkPermission([{listName:"Transaction",opName:"read"},{listName:"AccountRecord",opName:"read"}])}]}}).state({name:"accRecStatisData",templateUrl:e+"statistics/acc-rec-aggregate.html",url:"/statistics/acc-rec-aggregate",controller:"AccRecAggPageCtrler as ctrler",resolve:{condition1:["myValidation",function(e){return e.checkPermission([{listName:"Transaction",opName:"read"},{listName:"AccountRecord",opName:"read"}])}]}}).state({name:"admin",templateUrl:e+"admin/index.html",url:"/admin-front",resolve:{condition1:["myValidation",function(e){return e.isAdmin(locals.user)}]}}).state({name:"adminAnnuallyWithdraw",templateUrl:e+"admin/annually-withdraw.html",url:"/admin-front/annually-withdraw",controller:"AnnuallyWithdrawPageCtrler as ctrler",resolve:{condition1:["myValidation",function(e){return e.isAdmin(locals.user)}]}}).state({name:"403",templateUrl:e+"error/403.html",url:"/error/403"}).onInvalid(function(e,t){return console.log("invalid state from ",t," to ",e),!1}),r.otherwise("/"),a.setPrefix("mainApp").setNotify(!1,!1)}]).run(["$state","$window","$http","$uibModal","$rootScope","$transitions","myValidation","cachedFarmersKey","appRootPath",function(e,t,r,a,o,n,l,i,c){console.log("config end, angular app start to run"),o.locals=locals,o.alerts=[],o.pubSuccessMsg=function(e){o.alerts.push({type:"success",msg:e})},o.pubWarningMsg=function(e){o.alerts.push({type:"warning",msg:e})},o.pubInfoMsg=function(e){o.alerts.push({type:"info",msg:e})},o.pubErrorMsg=function(e){o.alerts.push({type:"danger",msg:e})},o.isLogin=function(){return locals.user},o.isPage=function(t){return e.current.name===t},o.openShopCart=function(){o.productPageCtrler&&o.productPageCtrler.openShopCart()},o.openProductEdit=function(){o.productPageCtrler&&o.productPageCtrler.openProductEditModal()},o.openProductTypeEdit=function(){o.productTypePageCtrler&&o.productTypePageCtrler.openEditModal()},o.openCachedFarmerList=function(){var e=a.open({templateUrl:c+"farmer/farmerList.html",controller:"CachedFarmerListCtrler as ctrler",size:"lg"});e.result.catch(function(){e.close()})},n.onError({},function(t){t&&("access denied"===t.error().detail&&e.go("403"))}),o.loadDone=!0}])}();
!function(){"use strict";angular.module("mainApp").controller("AnnuallyWithdrawPageCtrler",["$http","$window","$rootScope","$uibModal","lodash","localStorageService","appRootPath",function(a,t,n,e,o,c,i){var s=this,r=new Date;s.cancelAWDate=r,s.downloadAWDate=r,s.doAWDate=new Date(r.getFullYear()+"/06/30"),s.doAWDate.setHours(12,0,0,0),s.code="000",s.doAW=function(){s.isProcessing=!0,a.post("/api/account/annually-withdraw",{code:s.code,date:s.doAWDate}).then(function(a){var t=a.data;if(t.success){var e=t.filename,o=new Blob([new Uint8Array(t.content.data)],{type:"text/plain"});saveAs(o,e),s.checkCode=t.checkCode,n.pubSuccessMsg("年度結清執行成功,已下載媒體檔")}}).catch(function(a){var t=a&&a.data?a.data.toString():a?a.toString():"";n.pubErrorMsg("年度結清執行失敗,"+t)}).finally(function(){s.isProcessing=!1})},s.cancelAW=function(){s.isProcessing=!0,a.post("/api/account/cancel-annually-withdraw",{date:s.cancelAWDate}).then(function(a){s.checkCode=void 0,a.data.success&&n.pubSuccessMsg("年度結清撤銷成功")}).catch(function(a){var t=a&&a.data?a.data.toString():a?a.toString():"";n.pubErrorMsg("年度結清撤銷失敗,"+t)}).finally(function(){s.isProcessing=!1})},s.downloadAWFile=function(){s.isProcessing=!0,a.post("/api/account/gen-annually-withdraw-file",{code:s.code,date:s.downloadAWDate}).then(function(a){var t=a.data;if(t.success){var e=t.filename,o=new Blob([new Uint8Array(t.content.data)],{type:"text/plain;charset=big-5"});saveAs(o,e),n.pubSuccessMsg("年度結清媒體檔已下載")}}).catch(function(a){var t=a&&a.data?a.data.toString():a?a.toString():"";n.pubErrorMsg("年度結清媒體檔下載失敗,"+t)}).finally(function(){s.isProcessing=!1})}}])}();
!function(){"use strict";angular.module("mainApp").controller("AccountPageCtrler",["$http","$window","$state","$rootScope","$uibModal","cachedFarmersKey","lodash","localStorageService","appRootPath",function(t,e,n,r,c,a,o,i,s){var u=this;if(n.params){var l=n.params.farmerPID;l?i.set("farmerDetail:farmerPID",l):l=i.get("farmerDetail:farmerPID"),u.accountUser="",u.getDetail=function(){t.post("/api/farmer/get-and-populate",{farmerPID:l,_populate:"village"}).then(function(t){var e=t.data;e.success?(u.farmer=e.result.farmer,u.accounts=e.result.accounts):r.pubWarningMsg(e.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";r.pubErrorMsg("抓取農民存摺資訊失敗,"+e),console.log(t)})},u.createAccount=function(){t.post("/api/account/create",{farmerPID:l,accountUser:u.accountUser,comment:u.comment}).then(function(t){var e=t.data;if(e.success){!u.accounts instanceof Array&&(u.accounts=[]);var n=u.accounts.length+1;r.pubSuccessMsg("存摺"+n.toString()+"開立成功"),u.accounts.push(e.result)}else r.pubWarningMsg(e.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";r.pubErrorMsg("開立存摺失敗,"+e),console.log(t)})},u.openCreateAccountModal=function(){var t=c.open({templateUrl:"create-account.html",controller:"CreateAccountModalCtrler as $ctrl",size:"md"});t.result.then(function(t){u.accountUser=t.accountUser,u.comment=t.comment,u.createAccount()}).catch(function(){t.close()})},u.openAccountDetail=function(t){t.farmer=u.farmer;var e=c.open({templateUrl:"account-detail.html",controller:"AccountDetailModalCtrler as ctrler",size:"lg",resolve:{account:function(){return t}}});e.result.then(function(t){r.pubSuccessMsg(t)}).catch(function(){e.close()})},u.openUpdateFarmerModal=function(){var e=c.open({templateUrl:s+"farmer/update.html",controller:"UpdateFarmerModalCtrler as ctrler",size:"md",resolve:{farmer:function(){return u.farmer}}});e.result.then(function(e){e._populate="village",t.post("/api/farmer/update",e).then(function(t){var e=t.data;e.success?(r.pubSuccessMsg("更新成功,頁面資料已更新"),u.farmer=e.result):r.pubErrorMsg("更新失敗,"+e.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";r.pubErrorMsg("更新失敗,"+e)})}).catch(function(){e.close()})},u.addFarmerToCache=function(){if(u.farmer){var t=i.get(a);t||(t=[]),-1===o.findIndex(t,function(t){return t.pid===u.farmer.pid})?(t.push(u.farmer),i.set(a,t),r.pubSuccessMsg("已加入暫存列表,可用於購物車等其他服務")):r.pubErrorMsg("該農民已在暫存列表")}}}else console.log("error: no params")}]).controller("CreateAccountModalCtrler",["$uibModalInstance",function(t){var e=this;e.result={accountUser:""},e.ok=function(){t.close(e.result)},e.cancel=function(){t.dismiss("cancel")}}]).controller("AccountDetailModalCtrler",["$uibModalInstance","account","$http","lodash","$q","Upload","$window","$scope",function(t,e,n,r,c,a,o,i){var s=this;s.account=e;var u=new Date;u.setFullYear(u.getFullYear()-1,6,1),s.startDateFilter=u,s.resetOpView=function(){s.closeAcc={},s.deposit={},s.withdraw={},s.setFreeze={},s.isProcessing=!1,s.withdraw.comment=s.account.farmer.name+" 白米存摺轉出",s.withdraw.ioAccount=s.account.farmer.ioAccount,s.deposit.comment=s.account.farmer.name+" 白米存摺轉入",s.deposit.ioAccount=s.account.farmer.ioAccount},s.resetOpView(),s.alerts=[],s.pubSuccessMsg=function(t){s.alerts.push({type:"success",msg:t})},s.pubWarningMsg=function(t){s.alerts.push({type:"warning",msg:t})},s.pubInfoMsg=function(t){s.alerts.push({type:"info",msg:t})},s.pubErrorMsg=function(t){s.alerts.push({type:"danger",msg:t})};var l=function(t,e,n){r.isString(n)?n.length>0&&(t[e]=n):r.isNumber(n)&&(t[e]=n)};s.getPeriods=function(t){return n.post("/api/read",{listName:"Period",contains:{name:t},limit:8}).then(function(t){return t.data.success?t.data.result:c.reject()})},s.changeQty=function(t,e){t.qty+=e},s.rmItem=function(t){if(s.edittingRec.products){var e=r.findIndex(s.edittingRec.products,function(e){return e.pid===t.pid});-1!==e&&s.edittingRec.products.splice(e,1)}},s.getTotal=function(){if(s.edittingRec&&s.edittingRec.products){var t=0;return s.edittingRec.products.forEach(function(e){t+=e.price*e.qty}),t}return 0},s.isUpdateRecButtonDisabled=function(){return!!s.edittingRec&&("transact"===s.edittingRec.opType.value?s.isProcessing||i.accountOpForm.editRecItemQty&&i.accountOpForm.editRecItemQty.$invalid:"withdraw"===s.edittingRec.opType.value||"deposit"===s.edittingRec.opType.value?s.isProcessing||i.accountOpForm.editRecAmount.$invalid:void 0)},s.depositOp=function(){s.isProcessing=!0;var t={_id:s.account._id,amount:s.deposit.amount};l(t,"period",s.deposit.period),l(t,"comment",s.deposit.comment),l(t,"ioAccount",s.deposit.ioAccount),n.post("/api/account/deposit",t).then(function(t){var e=t.data;if(e.success){r.assign(s.account,e.result),s.resetOpView(),s.getAccountRecords();var n=s.account.lastRecord;return s.downloadDWSheetOp(n,"deposit","入款成功,頁面資料已更新")}s.pubErrorMsg("入款失敗,"+e.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";s.pubErrorMsg("入款失敗,"+e)}).finally(function(){s.isProcessing=!1})},s.withdrawOp=function(){s.isProcessing=!0;var t={_id:s.account._id,amount:s.withdraw.amount};l(t,"comment",s.withdraw.comment),l(t,"ioAccount",s.withdraw.ioAccount),n.post("/api/account/withdraw",t).then(function(t){var e=t.data;if(e.success){r.assign(s.account,e.result),s.resetOpView(),s.getAccountRecords();var n=s.account.lastRecord;return s.downloadDWSheetOp(n,"withdraw","提款成功,頁面資料已更新")}s.pubErrorMsg("提款失敗,"+e.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";s.pubErrorMsg("提款失敗,"+e)}).finally(function(){s.isProcessing=!1})},s.FileSizeLimit="1MB",s.unfreezeFileSelect=function(t,e){s.errFile=e&&e[0],"maxSize"===s.errFile.$error?s.errFile.errorChMsg="超過檔案限制 "+s.FileSizeLimit:s.errFile.errorChMsg=s.errFile.$error},s.downloadUnfreezeSheetOp=function(){s.isProcessing=!0,n.post("/pdf/unfreeze-sheet",{_id:s.account._id}).then(function(t){var e=t.data.filename,n=new Blob([new Uint8Array(t.data.content.data)],{type:"application/pdf"});saveAs(n,e),s.pubSuccessMsg("下載解凍單成功")}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";s.pubErrorMsg("下載解凍單失敗,"+e)}).finally(function(){s.isProcessing=!1})},s.setFreezeOp=function(){s.isProcessing=!0;var t={_id:s.account._id};l(t,"comment",s.setFreeze.comment);var e=new FormData;s.setFreeze.unfreezeSheet&&e.append("relatedFile",s.setFreeze.unfreezeSheet),e.append("opData",angular.toJson(t)),a.http({url:"/api/account/set-freeze",headers:{"Content-type":void 0},data:e}).then(function(t){var e=t.data;e.success?(r.assign(s.account,e.result),s.resetOpView(),s.getAccountRecords(),s.pubSuccessMsg((s.account.freeze?"凍結成功":"解凍成功")+",頁面資料已更新")):s.pubErrorMsg("失敗,"+e.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";s.pubErrorMsg("失敗,"+e)}).finally(function(){s.isProcessing=!1},function(t){s.setFreeze.uploadProgress=parseInt(100*t.loaded/t.total)})},s.closeAccOp=function(){s.isProcessing=!0;var t={_id:s.account._id};l(t,"comment",s.closeAcc.comment),n.post("/api/account/close",t).then(function(t){var e=t.data;e.success?(r.assign(s.account,e.result),s.resetOpView(),s.getAccountRecords(),s.pubSuccessMsg("結清成功,已呈現最新資料")):s.pubErrorMsg("結清失敗,"+e.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";s.pubErrorMsg("結清失敗,"+e)}).finally(function(){s.isProcessing=!1})},s.accUserChangeOp=function(){s.isProcessing=!0;var t={_id:s.account._id,newUser:s.accUserChange.newUser};l(t,"comment",s.accUserChange.comment),n.post("/api/account/change-acc-user",t).then(function(t){var e=t.data;e.success?(r.assign(s.account,e.result),s.resetOpView(),s.getAccountRecords(),s.pubSuccessMsg("過戶成功,已呈現最新資料")):s.pubErrorMsg("過戶失敗,"+e.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";s.pubErrorMsg("過戶失敗,"+e)}).finally(function(){s.isProcessing=!1})},s.cancel=function(){t.dismiss("cancel")}}]).controller("UpdateFarmerModalCtrler",["$uibModalInstance","farmer","geoDataService","$rootScope",function(t,e,n,r){var c=this;c.farmer=_.clone(e,!1),c.farmer.birth=Date.parse(c.farmer.birth),c.selectOnChange=function(t,e){return"dists"===t&&(c.distSelect=null,c.villages=null),n.fetch(t,e).then(function(e){return c[t]=e,e})};c.getCities=function(){c.selectOnChange("cities",null).then(function(t){return c.citySelect=_.find(c.cities,function(t){return t._id===c.farmer.city}),c.selectOnChange("dists",c.citySelect._id)}).then(function(t){return c.distSelect=_.find(c.dists,function(t){return t._id===c.farmer.dist}),c.selectOnChange("villages",c.distSelect._id)}).then(function(t){c.villageSelect=_.find(c.villages,function(t){return t._id===c.farmer.village._id})}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";r.pubErrorMsg("抓取地理資訊失敗,"+e),console.log(t)})},c.ok=function(){c.farmer.city=c.citySelect._id,c.farmer.dist=c.distSelect._id,c.farmer.village=c.villageSelect._id,c.hasOwnProperty("cities")&&c.hasOwnProperty("dists")&&c.citySelect&&c.distSelect?c.farmer.addr=c.citySelect.name+c.distSelect.dist+c.farmer.addrRest:c.farmer.addr="",t.close(c.farmer)},c.cancel=function(){t.dismiss("cancel")}}])}();
!function(){"use strict";angular.module("mainApp").controller("CachedFarmerListCtrler",["cachedFarmersKey","lodash","localStorageService","$state","$uibModalInstance",function(r,e,a,t,i){var s=this,n=a.get(r);s.farmers=n||[],s.rmFarmerFromList=function(t){var i=e.findIndex(s.farmers,function(r){return r.pid===t.pid});-1!==i&&(s.farmers.splice(i,1),a.set(r,s.farmers))},s.goDetailPage=function(r){a.set("farmerDetail:farmerPID",r.pid),t.go("farmerDetail"),i.dismiss()}}])}();
!function(){"use strict";angular.module("mainApp").controller("FarmerPageCtrler",["myValidation","$http","$window","$state","$rootScope","geoDataService","lodash",function(e,t,i,n,r,a,c){var s=this;s.birth=new Date(1980,0,1),s.showRegisterTable=!1,s.isRegistering=!1,s.isSearching=!1,s.selectOnChange=function(e,t){return"dists"===e&&(s.distSelect=null,s.villages=null),a.fetch(e,t).then(function(t){return s[e]=t,t}).catch(function(e){var t=e&&e.data?e.data.toString():e?e.toString():"";r.pubErrorMsg("抓取地理資訊失敗,"+t),console.log(e)})};var l=function(e){return e?e.replace(/\D+/g,""):""};s.refreshData=function(){var e;s.pid&&(s.pid=s.pid.toUpperCase()),s.hasOwnProperty("cities")&&s.hasOwnProperty("dists")&&s.citySelect&&s.distSelect?s.fullAddr=s.citySelect.name+s.distSelect.dist+s.addrRest:s.fullAddr="",s.tele1=l(s.tele1),s.tele2=l(s.tele2),s.ioAccount=(e=s.ioAccount)?e.replace(/[^A-Z0-9]/gi,""):""},s.registerFarmer=function(){var e={name:s.farmerName,pid:s.pid,birth:s.birth,teleNum1:s.tele1,teleNum2:s.tele2,city:s.citySelect._id,dist:s.distSelect._id,village:s.villageSelect._id,addrRest:s.addrRest,addr:s.fullAddr,ioAccount:s.ioAccount};s.isRegistering=!0,t.post("/api/farmer/register",e).then(function(e){var t=e.data;t.success?(console.log("register farmer success"),r.pubSuccessMsg("註冊成功,即將返回入口頁面"),setTimeout(function(){n.go("farmer")},3e3)):r.pubWarningMsg("註冊失敗,"+t.message)}).catch(function(e){var t=e&&e.data?e.data.toString():e?e.toString():"";r.pubErrorMsg("註冊失敗,"+t)}).finally(function(){s.isRegistering=!1})};s.getCities=function(){s.selectOnChange("cities",null).then(function(e){!function(e){if(r.locals){var t=r.locals.sys;s.citySelect=c.find(s.cities,function(e){return e._id===t.cityDist.city}),s.selectOnChange("dists",s.citySelect._id).then(function(i){"city"!==e&&(s.distSelect=c.find(s.dists,function(e){return e._id===t.cityDist._id}),s.selectOnChange("villages",s.distSelect._id))})}}()})},s.maxCanDisplay=50,s.search=function(){var e={name:s.farmerName&&s.farmerName.length?s.farmerName:void 0,pid:s.pid&&s.pid.length?s.pid:void 0,tele:s.tele&&s.tele.length?s.tele:void 0,city:s.citySelect?s.citySelect._id:void 0,dist:s.distSelect?s.distSelect._id:void 0,village:s.villageSelect?s.villageSelect._id:void 0,_limit:s.maxCanDisplay};s.isSearching=!0,t.post("/api/farmer/search",e).then(function(e){var t=e.data;t.success?(t.result&&0!=t.result.length||r.pubInfoMsg("無任何結果,請更改條件再行搜尋"),s.farmers=t.result,s.numTotalResult=t.total):(s.farmers=[],r.pubWarningMsg(t.message))}).catch(function(e){var t=e&&e.data?e.data.toString():e?e.toString():"";r.pubErrorMsg("搜尋失敗,"+t),console.log(e)}).finally(function(){s.isSearching=!1})}}])}();
!function(){"use strict";angular.module("mainApp").controller("HomeCtrler",["$http","$rootScope",function(o,t){}])}();
!function(){"use strict";angular.module("mainApp").controller("ProductPageCtrler",["appRootPath","$http","$window","$state","ngCart","$filter","$rootScope","$uibModal","ngCartItem","$scope","lodash","localStorageService","cachedFarmersKey",function(t,e,c,n,r,a,o,u,s,i,l,d,p){o.productPageCtrler=this;a("listTo2DMat");var f=this;if(f.productTypeTemplatePath=t+"product/product-type.html",f.getProducts=function(t){return e.post("/api/product/get",{mode:t}).then(function(t){var e=t.data;e.success?f.productList=e.result:console.log(e.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";o.pubErrorMsg("抓取商品資訊失敗,"+e)})},"productSell"===n.current.name){f.clearCart=function(){r.empty(),f.productList.forEach(function(t){t.isInCart=!1})},f.viewDetail=function(){};var g=function(t){var c=r.getItems().map(function(t){var e={};return e._id=t._id,t.marketPrice===t.price?e.price="market":t.exchangePrice===t.price?e.price="exchange":e.price=t.price,e.qty=t.quantity,e});e.post("/api/product/transact",{_id:t.tranAccount._id,products:c}).then(function(t){var e,c,n=t.data;n.success?(e=n.result,(c=u.open({templateUrl:"checkout-result.html",controller:"CheckoutResultPageCtrler as ctrler",size:"lg",resolve:{checkoutResult:function(){return e}}})).result.catch(function(t){c.close()}),d.get(p).forEach(function(t){d.remove(t.pid+",accounts:")}),f.clearCart()):o.pubErrorMsg("兌換失敗,原因"+n.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";o.pubErrorMsg("兌換失敗,原因"+e)})};f.openShopCart=function(){var t=u.open({templateUrl:"cart-and-checkout.html",controller:"ShopCartModalCtrler as ctrler",size:"lg",resolve:{curShopCart:function(){return r}}});t.result.then(function(t){g(t)}).catch(function(e){"clear"===e&&(f.clearCart(),o.pubSuccessMsg("已清空購物車")),t.close()})},f.addItemToCart=function(t){r.addItem(t),t.isInCart=!0},f.rmItemFromCart=function(t){r.removeItemById(t._id),t.isInCart=!1},f.isItemInCart=function(t){return r.isItemInCart(t._id)},f.qtyIsNaN=function(t){return isNaN(t.quantity)},f.changeQty=function(t,e){isNaN(t.quantity)||(t.quantity+=e)};var h="riceShop";locals&&locals.user&&(h=locals.user.userID+"-cart"),r.init(h),r.$restore(),r.setTaxRate(5),r.setShipping(1),f.getProducts("saleable").then(function(){f.productList=f.productList.map(function(t){var e=r.getItemById(t._id);return e?(t.isInCart=!0,l.assign(e,t),e):((t=new s(t)).isInCart=!1,t.price=t.exchangePrice,t.quantity=1,t)})})}else if("productManage"===n.current.name){f.openProductEditModal=function(t){var c=u.open({templateUrl:"product-edit-modal.html",controller:"ProductEditModalCtrler as ctrler",size:"md",resolve:{product:function(){return t}}});c.result.then(function(t){!function(t){e.post("/api/product/upsert",t).then(function(t){var e=t.data;if(e.success){var c=e.result,n=l.find(f.productList,function(t){return t._id===c._id});n?l.assign(n,c):f.productList.push(c),o.pubSuccessMsg("新增成功,已更新畫面")}else o.pubErrorMsg("更新失敗,"+e.message)}).catch(function(t){o.pubErrorMsg(t&&t.data?t.data.toString():t?t.toString():"")})}(t)}).catch(function(){c.close()})},f.deleteProduct=function(t){!0===confirm("確定要刪除這個產品嗎")&&e.post("/api/product/delete",{_id:t._id}).then(function(e){var c=e.data;c.success?(!function(t){var e=l.findIndex(f.productList,function(e){return e._id===t._id});-1!==e&&f.productList.splice(e,1)}(t),o.pubSuccessMsg("刪除成功,已更新畫面")):o.pubErrorMsg("刪除失敗,"+c.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";o.pubErrorMsg("刪除商品失敗,"+e)})},f.getProductStatus=function(t){return t.canSale?new Date(t.startSaleDate)<=Date.now()?"販售中":"等待上架":"下架中"},f.getProducts("all")}}]).controller("ProductEditModalCtrler",["$http","$uibModalInstance","product","lodash",function(t,e,c,n){var r=this;if(c){var a=n.clone(c,!1);r.product=a,a.startSaleDate=Date.parse(a.startSaleDate)}else r.product={};r.getProductTypes=function(){t.post("/api/read",{listName:"ProductType"}).then(function(t){var e=t.data;e.success?(r.pTypeVals=e.result,r.product.pType&&(r.product.pType=n.find(r.pTypeVals,function(t){return t._id===r.product.pType._id}))):console.log(err.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";$rootScope.pubErrorMsg("抓取商品類型資訊失敗,"+e)})},r.ok=function(){e.close(r.product)},r.cancel=function(){e.dismiss("cancel")},r.pTypeSelect=function(){r.product.pid=r.product.pType.code},r.getProductTypes()}]).controller("ShopCartModalCtrler",["$q","$http","$uibModalInstance","curShopCart","localStorageService","cachedFarmersKey","lodash","$scope",function(t,e,c,n,r,a,o,u){var s=this;s.alerts=[],s.pubSuccessMsg=function(t){s.alerts.push({type:"success",msg:t})},s.pubWarningMsg=function(t){s.alerts.push({type:"warning",msg:t})},s.pubInfoMsg=function(t){s.alerts.push({type:"info",msg:t})},s.pubErrorMsg=function(t){s.alerts.push({type:"danger",msg:t})};var i=function(c){return e.post("/api/farmer/get-and-populate",{farmerPID:c,active:!0,freeze:!1}).then(function(e){var n=e.data;return n.success?(s.accounts=n.result.accounts,s.accounts&&s.accounts.length>0?r.set(c+",accounts:",s.accounts):s.accounts=[],s.accounts):t.reject()}).catch(function(t){s.pubErrorMsg(t.toString())})};if(s.farmerSelected=function(t){if(s.selectedFarmer){var e=s.selectedFarmer.pid;r.set("ProductPage:selectedFarmer",e),i(e).then(function(){var t=r.get(e+",ProductPage:selectedAccount:");s.selectedAccount=t?o.find(s.accounts,function(e){return e._id===t}):o.find(s.accounts,function(t){return t.active})})}},s.isUpdatingAccount=!1,s.updateAccountsInfo=function(){if(s.selectedFarmer){s.isUpdatingAccount=!0;var t=s.selectedAccount?s.selectedAccount._id:null;i(s.selectedFarmer.pid).then(function(){s.selectedAccount=o.find(s.accounts,function(e){return e._id===t})}).finally(function(){s.isUpdatingAccount=!1})}},s.accountSelected=function(){s.selectedAccount&&r.set(s.selectedFarmer.pid+",ProductPage:selectedAccount:",s.selectedAccount._id)},s.isBalanceNotEnough=function(){return!!s.selectedAccount&&s.selectedAccount.balance<s.getTotalPrice()},s.rmItemFromCart=function(t){n.removeItemById(t._id),t.isInCart=!1},s.saveCart=function(){n.$save()},s.checkout=function(){c.close({tranAccount:s.selectedAccount})},s.cancel=function(t){c.dismiss(t||"cancel")},s.cartEmpty=function(){return 0===n.getItems().length},s.changeQty=function(t,e){isNaN(t.quantity)||(t.quantity+=e,s.saveCart())},s.getTotalPrice=function(){return n.getSubTotal()},s.getAfterBalance=function(){return s.selectedAccount?s.selectedAccount.balance-s.getTotalPrice():-1},s.isViaCachedList=function(){return"viaCachedList"===s.accountSrcOpt},s.isViaAccountID=function(){return"viaAccountID"===s.accountSrcOpt},s.setSelectedAccount=function(){s.inputAccID&&s.inputAccID.length>0?(s.isUpdatingAccount=!0,e.post("/api/read",{listName:"Account",filters:{accountID:s.inputAccID}}).then(function(t){var e=t.data;e.success?e.result instanceof Array?e.result.length>0?s.selectedAccount=e.result[0]:s.pubErrorMsg("沒找到相對應的存摺"):e.result?s.selectedAccount=e.result:s.pubWarningMsg("沒有找到存摺"):s.pubErrorMsg("沒找到相對應的存摺,"+e.message)}).catch(function(t){s.pubErrorMsg("失敗,"+msg)}).finally(function(){s.isUpdatingAccount=!1})):alert("請輸入存摺編號")},s.keyPressedInAccIDInput=function(t){13===t.keyCode&&(t.preventDefault(),s.setSelectedAccount())},s.cartItems=n.getItems(),s.cachedFarmers=r.get(a),s.cachedFarmers&&s.cachedFarmers.length>0){var l=r.get("ProductPage:selectedFarmer");s.selectedFarmer=l?o.find(s.cachedFarmers,function(t){return t.pid===l}):s.cachedFarmers[0],s.farmerSelected()}u.$watch("ctrler.selectedAccount",function(t){t&&t.balance>=s.getTotalPrice()?u.cartForm.accountData.$setValidity("balanceEnough",!0):u.cartForm.accountData.$setValidity("balanceEnough",!1)})}]).controller("CheckoutResultPageCtrler",["$uibModalInstance","checkoutResult",function(t,e){this.total=e.transaction.amount,this.account=e.account,this.transactedItems=e.transaction.products,this.cancel=function(){t.dismiss()}}])}();
!function(){"use strict";angular.module("mainApp").controller("ProductTypePageCtrler",["$http","$uibModal","$rootScope","lodash",function(t,e,r,o){var n=this;n.pTypes=[],r.productTypePageCtrler=this,n.getProductTypes=function(){t.post("/api/read",{listName:"ProductType"}).then(function(t){var e=t.data;e.success?n.pTypes=e.result:console.log(err.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";r.pubErrorMsg("抓取商品類型資訊失敗,"+e)})};n.openEditModal=function(c){var s=e.open({templateUrl:"product-type-edit-modal.html",controller:"ProductTypeEditModalCtrler as ctrler",size:"md",resolve:{productType:function(){return c}}});s.result.then(function(e){!function(e){t.post("/api/p-type/upsert",e).then(function(t){var e=t.data;if(e.success){r.pubSuccessMsg("操作成功");var c=e.result,s=o.find(n.pTypes,function(t){return t._id===c._id});s?o.assign(s,c):n.pTypes.push(c)}else r.pubErrorMsg("更新失敗,"+e.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";r.pubErrorMsg("更新失敗,"+e)})}(e)}).catch(function(){s.close()})},n.getProductTypes()}]).controller("ProductTypeEditModalCtrler",["$uibModalInstance","productType",function(t,e){var r=this;r.productType=e?_.clone(e,!1):{},r.ok=function(){t.close(r.productType)},r.cancel=function(){t.dismiss("cancel")}}])}();
!function(){"use strict";angular.module("ngCart",["ngCart.directives","ngLodash"]).config([function(){}]).provider("$ngCart",function(){this.$get=function(){}}).run(["$rootScope","ngCart","ngCartItem","store",function(t,e,n,r){}]).service("ngCart",["$rootScope","$window","ngCartItem","store",function(t,e,n,r){var i,o=this;this.init=function(t){i={shipping:null,taxRate:null,tax:null,items:[],storeKey:t||"ngShop"}},this.setStoreKey=function(t){i.storeKey=t},this.addItem=function(e){var r=this.getItemById(e._id);return"object"==typeof r?(r.setName(name),r.setPrice(price),r.setQuantity(quantity,!1),r.weight=e.weight,r.image=e.image,t.$broadcast("ngCart:itemUpdated",r)):(r=e instanceof n?e:new n(e),i.items.push(r),t.$broadcast("ngCart:itemAdded",r)),t.$broadcast("ngCart:change"),r},this.getItemById=function(t){var e=!1;return i.items.some(function(n){return n.getId()===t&&(e=n,!0)}),e},this.isItemInCart=function(t){return i.items.some(function(e){return e.getId()===t})},this.setShipping=function(t){return i.shipping=t,this.getShipping()},this.getShipping=function(){return 0==i.items.length?0:i.shipping},this.setTaxRate=function(t){return i.taxRate=+parseFloat(t).toFixed(2),this.getTaxRate()},this.getTaxRate=function(){return i.taxRate},this.getTax=function(){return+parseFloat(this.getSubTotal()/100*this.getCart().taxRate).toFixed(2)},this.setCart=function(t){return i=t},this.getCart=function(){return i},this.getItems=function(){return i.items},this.getTotalItems=function(){var t=0,e=this.getItems();return angular.forEach(e,function(e){t+=e.getQuantity()}),t},this.getTotalUniqueItems=function(){return i.items.length},this.getSubTotal=function(){var t=0;return angular.forEach(i.items,function(e){t+=e.getTotal()}),+parseFloat(t).toFixed(2)},this.totalCost=function(){return+parseFloat(this.getSubTotal()+this.getShipping()+this.getTax()).toFixed(2)},this.removeItem=function(e){var n=i.items.splice(e,1)[0]||{};t.$broadcast("ngCart:itemRemoved",n),t.$broadcast("ngCart:change")},this.removeItemById=function(e){var n=i;angular.forEach(n.items,function(t,r){t.getId()===e&&(t=n.items.splice(r,1)[0]||{})}),this.setCart(n),t.$broadcast("ngCart:itemRemoved",void 0),t.$broadcast("ngCart:change")},this.empty=function(){t.$broadcast("ngCart:change"),i.items=[],e.localStorage.removeItem(i.storeKey)},this.isEmpty=function(){return!(i.items.length>0)},this.toObject=function(){if(0===this.getItems().length)return!1;var t=[];return angular.forEach(this.getItems(),function(e){t.push(e.toObject())}),{shipping:this.getShipping(),tax:this.getTax(),taxRate:this.getTaxRate(),subTotal:this.getSubTotal(),totalCost:this.totalCost(),items:t}},this.$restore=function(t){var e;e=t?r.get(t):r.get(i.storeKey),i.items=[],i.shipping=e.shipping,i.tax=e.tax,angular.forEach(e.items,function(t){i.items.push(new n(t))}),this.$save()},this.dataIsValid=function(){return!(i.items.length>0)||i.items.every(function(t){return!isNaN(t.getTotal())})},this.$save=function(){if(this.dataIsValid())return r.set(i.storeKey,JSON.stringify(i))},t.$on("ngCart:change",function(){o.$save()})}]).factory("ngCartItem",["$rootScope","$log","lodash",function(t,e,n){var r=function(t){n.assign(this,t)};return r.prototype.setId=function(t){t?this._id=t:e.error("An ID must be provided")},r.prototype.getId=function(){return this._id},r.prototype.setName=function(t){t?this.name=t:e.error("A name must be provided")},r.prototype.getName=function(){return this.name},r.prototype.setPrice=function(t){var n=parseFloat(t);n?n<=0?e.error("A price must be over 0"):this.price=n:e.error("A price must be provided")},r.prototype.getPrice=function(){return this.price},r.prototype.setQuantity=function(t,n){var r=parseInt(t);r%1==0?(!0===n?this.quantity+=r:this.quantity=r,this.quantity<1&&(this.quantity=1)):(this.quantity=1,e.info("Quantity must be an integer and was defaulted to 1"))},r.prototype.getQuantity=function(){return this.quantity},r.prototype.setData=function(t){t&&(this.data=t)},r.prototype.getData=function(){if(this.data)return this.data;e.info("This item has no data")},r.prototype.getTotal=function(){return+parseFloat(this.getQuantity()*this.getPrice()).toFixed(2)},r.prototype.toObject=function(){return{id:this.getId(),name:this.getName(),price:this.getPrice(),quantity:this.getQuantity(),data:this.getData(),total:this.getTotal()}},r}]).service("store",["$window",function(t){return{get:function(e){var n=t.localStorage.getItem(e);if(n){var r=angular.fromJson(n);return JSON.parse(r)}return!1},set:function(e,n){return void 0===n?t.localStorage.removeItem(e):t.localStorage.setItem(e,angular.toJson(n)),t.localStorage.getItem(e)}}}]).controller("CartController",["$scope","ngCart",function(t,e){t.ngCart=e}]).value("version","1.0.0"),angular.module("ngCart.directives",["ngCart.fulfilment"]).controller("CartController",["$scope","ngCart",function(t,e){t.ngCart=e}]).directive("ngcartAddtocart",["ngCart",function(t){return{restrict:"E",controller:"CartController",scope:{id:"@",name:"@",quantity:"@",quantityMax:"@",price:"@",data:"="},transclude:!0,templateUrl:function(t,e){return void 0===e.templateUrl?"template/ngCart/addtocart.html":e.templateUrl},link:function(e,n,r){e.attrs=r,e.inCart=function(){return t.getItemById(r.id)},e.inCart()?e.q=t.getItemById(r.id).getQuantity():e.q=parseInt(e.quantity),e.qtyOpt=[];for(var i=1;i<=e.quantityMax;i++)e.qtyOpt.push(i)}}}]).directive("ngcartCart",[function(){return{restrict:"E",controller:"CartController",scope:{},templateUrl:function(t,e){return void 0===e.templateUrl?"template/ngCart/cart.html":e.templateUrl},link:function(t,e,n){}}}]).directive("ngcartSummary",[function(){return{restrict:"E",controller:"CartController",scope:{},transclude:!0,templateUrl:function(t,e){return void 0===e.templateUrl?"template/ngCart/summary.html":e.templateUrl}}}]).directive("ngcartCheckout",[function(){return{restrict:"E",controller:["$rootScope","$scope","ngCart","fulfilmentProvider",function(t,e,n,r){e.ngCart=n,e.checkout=function(){r.setService(e.service),r.setSettings(e.settings),r.checkout().success(function(e,n,r,i){t.$broadcast("ngCart:checkout_succeeded",e)}).error(function(e,n,r,i){t.$broadcast("ngCart:checkout_failed",{statusCode:n,error:e})})}}],scope:{service:"@",settings:"="},transclude:!0,templateUrl:function(t,e){return void 0===e.templateUrl?"template/ngCart/checkout.html":e.templateUrl}}}]),angular.module("ngCart.fulfilment",[]).service("fulfilmentProvider",["$injector",function(t){this._obj={service:void 0,settings:void 0},this.setService=function(t){this._obj.service=t},this.setSettings=function(t){this._obj.settings=t},this.checkout=function(){return t.get("ngCart.fulfilment."+this._obj.service).checkout(this._obj.settings)}}]).service("ngCart.fulfilment.log",["$q","$log","ngCart",function(t,e,n){this.checkout=function(){var r=t.defer();return e.info(n.toObject()),r.resolve({cart:n.toObject()}),r.promise}}]).service("ngCart.fulfilment.http",["$http","ngCart",function(t,e){this.checkout=function(n){return t.post(n.url,{data:e.toObject(),options:n.options})}}]).service("ngCart.fulfilment.paypal",["$http","ngCart",function(t,e){}])}();
!function(){"use strict";angular.module("mainApp").controller("AccRecAggPageCtrler",["$http","$window","$state","$rootScope","lodash","localStorageService","$uibModal",function(a,e,t,g,n,c,r){var o=this;o.pubSuccessMsg=function(a){g.pubSuccessMsg(a)},o.pubWarningMsg=function(a){g.pubWarningMsg(a)},o.pubInfoMsg=function(a){g.pubInfoMsg(a)},o.pubErrorMsg=function(a){g.pubErrorMsg(a)},o.setAggregateResult=function(a){var e={};a.countOpTypeAndSumAmount.forEach(function(a){e[a._id]=a}),["create","close","freeze","unfreeze","deposit","withdraw","transact","accUserChange","annuallyWithdraw"].forEach(function(a){e[a]||(e[a]={_id:a,count:0,amount:0})});var t={};["all","freeze","unfreeze"].forEach(function(a){t[a]={count:0,balance:0}}),a.aggAcc.forEach(function(a){a._id.freeze?(t.freeze.count+=a.count,t.freeze.balance+=a.balance):(t.unfreeze.count+=a.count,t.unfreeze.balance+=a.balance),t.all.count+=a.count,t.all.balance+=a.balance}),o.aggregateData.accAgg=t,o.aggregateData.accRecsAgg=e},o.aggregateAccRecs=function(e){o.isAggregating=!0,o.aggregateData||(o.aggregateData={}),delete o.aggregateData.accAgg,delete o.aggregateData.accRecsAgg,o.aggregateData.startDate=o.filters.date&&n.isDate(o.filters.date.$gte)?new Date(o.filters.date.$gte):void 0,o.aggregateData.endDate=o.filters.date&&n.isDate(o.filters.date.$lt)?new Date(o.filters.date.$lt):void 0,o.aggregateData.endDate&&o.aggregateData.endDate.setHours(-24,0,0,0),a.post("/api/account-rec/aggregate",{filters:o.filters}).then(function(a){var e=a.data;e.success&&(o.setAggregateResult(e.result),o.pubSuccessMsg("統計成功"))}).catch(function(a){var e=a&&a.data?a.data.toString():a?a.toString():"";o.pubErrorMsg("統計失敗,"+e)}).finally(function(){o.isAggregating=!1})},o.downloadAccRecsAggInfoPDF=function(e){o.isDownloading=!0,a.post("/pdf/acc-recs-aggregate",{tag:e,startDate:o.aggregateData.startDate,endDate:o.aggregateData.endDate,accRecsAgg:o.aggregateData.accRecsAgg,accAgg:o.aggregateData.accAgg}).then(function(a){var t=a.data.filename,g=new Blob([new Uint8Array(a.data.content.data)],{type:"application/pdf"});saveAs(g,t),"all"===e?o.pubSuccessMsg("下載交易匯總統計表成功"):o.pubSuccessMsg("下載年度結清總表成功")}).catch(function(a){var t=a&&a.data?a.data.toString():a?a.toString():"";"all"===e?o.pubErrorMsg("下載交易匯總統計表失敗,"+t):o.pubErrorMsg("下載年度結清總表失敗,"+t)}).finally(function(){o.isDownloading=!1})}}])}();
!function(){"use strict";angular.module("mainApp").controller("TransListPageCtrler",["$http","$window","$state","$rootScope","lodash","localStorageService","$uibModal",function(t,a,e,r,n,o,i){var s=this;s.filters={},s.shopFilterSelected=function(){s.shopFilter&&"any"!==s.shopFilter&&(s.applyShopFilter=!0)},s.initDateFilter=function(){var t=new Date;t.setHours(0,0,0,0),s.startDateFilter=t,s.endDateFilter=t,s.applyDateFilter=!0,s.filterChange()},s.datePickerChange=function(){(n.isDate(s.endDateFilter)||n.isDate(s.startDateFilter))&&(s.applyDateFilter=!0)},s.filterChange=function(){var t={};if(s.applyShopFilter&&s.shopFilter&&"any"!==s.shopFilter&&(t.shop=s.shopFilter),n.isDate(s.endDateFilter)&&s.endDateFilter<s.startDateFilter&&(s.endDateFilter=s.startDateFilter),s.applyDateFilter)if(n.isDate(s.startDateFilter)){var a=new Date(s.startDateFilter);if(a.setHours(0,0,0,0),n.isDate(s.endDateFilter))(e=new Date(s.endDateFilter)).setHours(24,0,0,0),t.date={$gte:a,$lt:e};else t.date={$gte:a}}else if(n.isDate(s.endDateFilter)){var e;(e=new Date(s.endDateFilter)).setHours(24,0,0,0),t.date={$lt:e}}s.filters=t,s.aggregateData={},s.getTransactionData()};var c={};s.getShops=function(){t.post("/api/read",{listName:"Shop"}).then(function(t){var a=t.data;a.success&&(s.shops=a.result,s.shops.forEach(function(t){c[t._id]=t}))}).catch(function(t){var a=t&&t.data?t.data.toString():t?t.toString():"";r.pubErrorMsg("讀取兌領處資訊失敗,"+a)})},s.perPage=10,s.curPage=1,s.getTransactionData=function(){t.post("/api/read",{listName:"Transaction",filters:s.filters,sort:"-date",populate:"trader shop account",page:s.curPage,perPage:s.perPage}).then(function(t){var a=t.data;a.success?(s.transactions=a.result,s.totalTrans=a.total):r.pubErrorMsg("讀取兌領記錄失敗,"+a.message)}).catch(function(t){var a=t&&t.data?t.data.toString():t?t.toString():"";r.pubErrorMsg("讀取兌領記錄失敗,"+a)})};s.deleteTrans=function(e){a.confirm("你確定要刪除此兌領紀錄嗎")&&t.post("/api/transaction/delete",{_id:e._id}).then(function(t){var a=t.data;a.success?(s.getTransactionData(),r.pubSuccessMsg("刪除兌領紀錄成功")):r.pubErrorMsg("刪除兌領紀錄失敗,"+a.message)}).catch(function(t){var a=t&&t.data?t.data.toString():t?t.toString():"";r.pubErrorMsg("刪除兌領紀錄失敗,"+a)})},s.openProductsModal=function(a,e){var n=i.open({templateUrl:"trans-detail-and-edit-modal.html",controller:"TransProductsModal as ctrler",size:"lg",resolve:{transaction:function(){return a},mode:function(){return e}}});n.result.then(function(a){var e;e=a,t.post("/api/transaction/update",{_id:e._id,products:e.products}).then(function(t){var a=t.data;a.success?(s.getTransactionData(),r.pubSuccessMsg("更新兌領紀錄成功")):r.pubErrorMsg("更新兌領紀錄失敗,"+a.message)}).catch(function(t){var a=t&&t.data?t.data.toString():t?t.toString():"";r.pubErrorMsg("更新兌領紀錄失敗,"+a)})}).catch(function(){n.close()})};var g={};s.getAggVal=function(t){if(s.aggregateData.products){var a=0;return"qty"===t?s.aggregateData.products.forEach(function(t){a+=t.qty}):"money"===t?s.aggregateData.products.forEach(function(t){a+=t.totalMoney}):"weight"===t?s.aggregateData.products.forEach(function(t){a+=t.totalWeight}):"price"===t&&s.aggregateData.products.forEach(function(t){a+=t._id.price}),a}return 0},s.aggregateData={},s.aggregateProducts=function(){s.aggregateData.products=void 0,s.isAggregating=!0,s.aggregateData.startDate=s.filters.date&&n.isDate(s.filters.date.$gte)?new Date(s.filters.date.$gte):void 0,s.aggregateData.endDate=s.filters.date&&n.isDate(s.filters.date.$lt)?new Date(s.filters.date.$lt):void 0,s.aggregateData.endDate&&s.aggregateData.endDate.setHours(-24,0,0,0),s.aggregateData.shop=s.filters.shop?c[s.filters.shop].name:void 0;var a={};n.isEmpty(s.filters)||(a.filters=s.filters),t.post("/api/transaction/aggregate-product",a).then(function(t){var a,e,o,i=t.data;i.success&&(a=i.result,e=a.basicInfo,o=a.productByShop,e.forEach(function(t){g[t._id]=t}),s.aggregateData.products=o.map(function(t){return n.assign(t._id,g[t._id.pid]),t.totalMoney=t._id.price*t.qty,t.totalWeight=t._id.weight*t.qty,t._id.shop=c[t._id.shop],t}),s.aggregateData.products&&s.aggregateData.products.sort(function(t,a){var e=t._id.pid.toUpperCase(),r=a._id.pid.toUpperCase();return e<r?-1:e>r?1:0}),s.aggregateData.transCount=a.transCount,r.pubSuccessMsg("統計成功,已更新畫面"))}).catch(function(t){var a=t&&t.data?t.data.toString():t?t.toString():"";r.pubErrorMsg("統計失敗,"+a)}).finally(function(){s.isAggregating=!1})},s.downloadProductAggInfoPDF=function(){s.isDownloading=!0,t.post("/pdf/transacted-products",{shop:s.aggregateData.shop,startDate:s.aggregateData.startDate,endDate:s.aggregateData.endDate,products:s.aggregateData.products,transCount:s.aggregateData.transCount}).then(function(t){var a=t.data.filename,e=new Blob([new Uint8Array(t.data.content.data)],{type:"application/pdf"});saveAs(e,a),r.pubSuccessMsg("下載兌領統計表成功")}).catch(function(t){var a=t&&t.data?t.data.toString():t?t.toString():"";r.pubErrorMsg("下載兌領統計表失敗,"+a)}).finally(function(){s.isDownloading=!1})}}]).controller("TransProductsModal",["$uibModalInstance","lodash","transaction","mode",function(t,a,e,r){var n=this,o=a.clone(e);n.products=o.products,n.changeQty=function(t,a){t.qty+=a},n.rmItem=function(t){if(n.products){var e=a.findIndex(n.products,function(a){return a.pid===t.pid});-1!==e&&n.products.splice(e,1)}},n.getTotal=function(){if(n.products){var t=0;return n.products.forEach(function(a){t+=a.price*a.qty}),t}return 0},n.isMode=function(t){return t===r},n.updateTrans=function(){t.close(o)},n.cancel=function(){t.dismiss()}}])}();
!function(){"use strict";angular.module("mainApp").controller("AccRecListCtrler",["$http","lodash","$window","$uibModal",function(e,t,c,a){var n=this;n.$onInit=function(){n.curPage=1,n.refreshAccRecs=n.getAccountRecords,n.updateRecFunc=n.updateRecOp,n.downloadDWSheetFunc=n.downloadDWSheetOp,n.initDateFilter(),n.filterChange()};var r={any:"任何",transact:"兌換",deposit:"入款",withdraw:"提款",close:"結清",freeze:"凍結",unfreeze:"解凍",create:"開戶",accUserChange:"過戶",annuallyWithdraw:"年度結清"};n.opTypes=[];for(let e in r)n.opTypes.push({name:r[e],value:e});n.initDateFilter=function(){var e=new Date;e.setHours(0,0,0,0),t.isDate(n.startDateFilter)||(n.startDateFilter=e),t.isDate(n.endDateFilter)||(n.endDateFilter=e),n.applyDateFilter=!0},n.getAccountRecords=function(){e.post("/api/read",{listName:"AccountRecord",filters:n.filters,sort:"-date",populate:"operator period account",select:"opType account amount date operator comment period ioAccount transaction",page:n.curPage,perPage:n.perPage}).then(function(e){var t=e.data;t.success?(t.result.forEach(function(e){e.opType={name:r[e.opType],value:e.opType}}),n.accountRecs=t.result,n.totalAccRecs=t.total,n.getAccRecSuccessCB&&n.getAccRecSuccessCB({accRecs:n.accountRecs,totalCount:n.totalAccRecs})):n.getAccRecErrorCB&&n.getAccRecErrorCB({msg:"讀取操作記錄失敗,"+t.message})}).catch(function(e){var t=e&&e.data?e.data.toString():e?e.toString():"";n.getAccRecErrorCB&&n.getAccRecErrorCB({msg:"讀取操作記錄失敗,"+t})})},n.opTypeFilterSelected=function(){n.opTypeFilter&&"any"!==n.opTypeFilter&&(n.applyOpTypeFilter=!0)},n.datePickerChange=function(){(t.isDate(n.endDateFilter)||t.isDate(n.startDateFilter))&&(n.applyDateFilter=!0)},n.filterChange=function(){var e={};if(n.account&&(e.account=n.account._id),n.applyOpTypeFilter&&n.opTypeFilter&&"any"!==n.opTypeFilter&&(e.opType=n.opTypeFilter),t.isDate(n.endDateFilter)&&n.endDateFilter<n.startDateFilter&&(n.endDateFilter=n.startDateFilter),n.applyDateFilter)if(t.isDate(n.startDateFilter)){var c=new Date(n.startDateFilter);if(c.setHours(0,0,0,0),t.isDate(n.endDateFilter))(a=new Date(n.endDateFilter)).setHours(24,0,0,0),e.date={$gte:c,$lt:a};else e.date={$gte:c}}else if(t.isDate(n.endDateFilter)){var a;(a=new Date(n.endDateFilter)).setHours(24,0,0,0),e.date={$lt:a}}n.filters=e,n.getAccountRecords()},n.isActCountZero=function(e){var t=e.opType.value;return"freeze"===t||"unfreeze"===t||"create"===t||"accUserChange"===t},n.hasAct=function(e,t){var c=e.opType.value;return"freeze"!==c&&"unfreeze"!==c&&"create"!==c&&"accUserChange"!==c&&("transact"===c?"delete"===t||"update"===t||"detail"===t:"close"===c||"annuallyWithdraw"===c?"delete"===t:"deposit"===c||"withdraw"===c?"delete"===t||"download"===t||"update"===t:void 0)},n.deleteRec=function(a){c.confirm("即將刪除此記錄, 確定嗎")&&e.post("/api/account-rec/delete",a).then(function(e){var c=e.data;c.success&&(n.deleteAccRecSuccessCB&&n.deleteAccRecSuccessCB({msg:"刪除紀錄成功,已更新畫面"}),n.edittingRec&&a._id===n.edittingRec._id&&(n.edittingRec=void 0),n.account&&t.assign(n.account,c.result),n.getAccountRecords())}).catch(function(e){var t=e&&e.data?e.data.toString():e?e.toString():"";n.deleteAccRecErrorCB&&n.deleteAccRecErrorCB({msg:"刪除紀錄失敗,"+t})})},n.selectEdittingRec=function(c,a){n.edittingRec=t.clone(c),"transact"===n.edittingRec.opType.value?e.post("/api/read/",{listName:"Transaction",filters:{_id:c.transaction}}).then(function(e){var t=e.data;t.success&&(n.edittingRec.products=t.result[0].products)}).catch(function(e){var t=e&&e.data?e.data.toString():e?e.toString():"";n.getTransErrorCB&&n.getTransErrorCB({msg:"抓取兌領紀錄失敗,"+t})}):n.edittingRec.period=n.edittingRec.period?n.edittingRec.period.name:n.edittingRec.period,n.edittingRec.readOnly=a,n.accountOp="update-rec","modal"===n.accRecEditMode&&n.openAccRecEditModal()},n.updateRecOp=function(){var c=n.edittingRec;"transact"!==c.opType.value||c.products&&0!==c.products.length?(n.isProcessing=!0,e.post("/api/account-rec/update",c).then(function(e){var c=e.data;c.success&&(n.account&&t.assign(n.account,c.result.account),n.getAccountRecords(),n.edittingRec=void 0,n.updateAccRecSuccessCB&&n.updateAccRecSuccessCB({msg:"更新存摺紀錄成功,已更新畫面"}))}).catch(function(e){var t=e&&e.data?e.data.toString():e?e.toString():"";n.updateAccRecErrorCB&&n.updateAccRecErrorCB({msg:"更新存摺紀錄失敗,"+t})}).finally(function(){n.isProcessing=!1})):n.updateAccRecErrorCB&&n.updateAccRecErrorCB({msg:"產品列表不能為空的,不然就請刪除此紀錄"})},n.downloadDWSheetOp=function(t,c,a){return n.isProcessing=!0,e.post("/pdf/deposit-withdraw-sheet",{op:c,_id:t._id?t._id:t}).then(function(e){var t=e.data.filename,c=new Blob([new Uint8Array(e.data.content.data)],{type:"application/pdf"});saveAs(c,t),n.downloadDWSheetSuccessCB&&(a?n.downloadDWSheetSuccessCB({msg:a+",轉帳單已下載"}):n.downloadDWSheetSuccessCB({msg:"下載轉帳單成功"}))}).catch(function(e){var t=e&&e.data?e.data.toString():e?e.toString():"";n.downloadDWSheetErrorCB&&n.downloadDWSheetErrorCB({msg:"下載轉帳單失敗,"+t})}).finally(function(){n.isProcessing=!1})},n.downloadRecPDF=function(e){"withdraw"!==e.opType.value&&"deposit"!==e.opType.value||n.downloadDWSheetOp(e,e.opType.value)},n.openAccRecEditModal=function(){var e="transact"===n.edittingRec.opType.value?"lg":"md",t=a.open({templateUrl:"acc-rec-edit.html",controller:"AccRecEditModalCtrler as ctrler",size:e,resolve:{accRec:function(){return n.edittingRec}}});t.result.then(function(){n.updateRecOp()}).catch(function(){n.edittingRec=void 0,t.close()})}}]).controller("AccRecEditModalCtrler",["$uibModalInstance","accRec","$scope","$http",function(e,t,c,a){var n=this;n.edittingRec=t,n.isModalMode=!0,n.getPeriods=function(e){return a.post("/api/read",{listName:"Period",contains:{name:e},limit:8}).then(function(e){return e.data.success?e.data.result:$q.reject()})},n.changeQty=function(e,t){e.qty+=t},n.rmItem=function(e){if(n.edittingRec.products){var t=_.findIndex(n.edittingRec.products,function(t){return t.pid===e.pid});-1!==t&&n.edittingRec.products.splice(t,1)}},n.getTotal=function(){if(n.edittingRec&&n.edittingRec.products){var e=0;return n.edittingRec.products.forEach(function(t){e+=t.price*t.qty}),e}return 0},n.isUpdateRecButtonDisabled=function(){return!!n.edittingRec&&("transact"===n.edittingRec.opType.value?n.isProcessing||c.accountOpForm.editRecItemQty&&c.accountOpForm.editRecItemQty.$invalid:"withdraw"===n.edittingRec.opType.value||"deposit"===n.edittingRec.opType.value?n.isProcessing||c.accountOpForm.editRecAmount.$invalid:void 0)},n.updateRec=function(){e.close()},n.cancel=function(){e.dismiss("cancel")}}]).component("accRecList",{templateUrl:locals.appRootPath+"common/component/acc-rec-list.html",bindings:{perPage:"@",showAccField:"<",showOperatorField:"<",accRecEditMode:"@",curPage:"=?",account:"=?",filters:"=?",opTypeFilter:"=?",applyDateFilter:"=?",startDateFilter:"=?",endDateFilter:"=?",accountOp:"=?",edittingRec:"=?",isProcessing:"=?",refreshAccRecs:"=?",updateRecFunc:"=?",downloadDWSheetFunc:"=?",getAccRecErrorCB:"&",getAccRecSuccessCB:"&",updateAccRecErrorCB:"&",updateAccRecSuccessCB:"&",deleteAccRecErrorCB:"&",deleteAccRecSuccessCB:"&",getTransErrorCB:"&",getTransSuccessCB:"&",downloadDWSheetSuccessCB:"&",downloadDWSheetErrorCB:"&"},controller:"AccRecListCtrler as ctrler"})}();
!function(){"use strict";angular.module("mainApp").filter("listTo2DMat",[function(){return function(n,t){if(!n||0===n.length)return[];var r=[],u=-1;return n.forEach(function(n,i){i%t==0&&(r[++u]=[]),r[u].push(n)}),r}}])}();
!function(){"use strict";angular.module("mainApp").filter("orFilter",["$filter",function(n){return function(r,t,u,e,i){var c=n("filter");if(t&&t.length>0&&u){var f=t.map(function(n){var t={};return t[n]=u,c(r,t,e)});return f=f.reduce(function(n,r){return n.concat(r)}),i?_.uniqBy(f,i):_.uniq(f)}return c(r,u,e)}}])}();
!function(){"use strict";angular.module("mainApp").service("geoDataService",["$http","localStorageService","$q",function(e,t,i){var s={dists:"city",villages:"cityDist"},r={cities:"City",dists:"AddrPrefix",villages:"Village"};this.fetch=function(a,l){var c,n=l?a+"-"+l:a,u=t.get(n);if(u)return i.resolve(u);if(l){var o={};o[s[a]]=l,c={listName:r[a],filters:o}}else c={listName:r[a]};return e.post("/api/read",c).then(function(e){var s=e.data;return s.success?(t.set(n,s.result),s.result):i.reject(s.message)})}}])}();
!function(){"use strict";angular.module("mainApp").service("myValidation",["$http","$rootScope","$q",function(e,t,i){this.checkPID=function(e,t){var i={};if(!e||10!==e.length)return t&&(i.message="身分證字號長度不正確",t(i)),!1;if(/^[A-Za-z][12][\d]{8}$/.test(e)||/^[A-Za-z][A-Da-d][\d]{8}$/.test(e)){var r="ABCDEFGHJKLMNPQRSTUVXYWZIO",n=[1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3],s=[0,1,2,3,4,5,6,7,8,9,0,1,2,3,4,5,6,7,8,9,0,1,2,3,4,5],a=[9,8,7,6,5,4,3,2,1,1],c=0;return e.split("").forEach(function(e,t){if(0==t){var i=r.indexOf(e.toUpperCase());c=1*n[i]+s[i]*a[t]}else if(1==t){var i=r.indexOf(e.toUpperCase());if(-1!=i)c+=i*a[t];else{var o=parseInt(e);isNaN(o)?c=o:c+=o*a[t]}}else{var o=parseInt(e);isNaN(o)?c=o:c+=o*a[t]}}),c%10==0?(t&&t(),!0):(t&&(i.message="不合法身分證字號",t(i)),!1)}return t&&(i.message="含不合法字元，請檢查",t(i)),!1},this.checkPermission=function(t){if(!t)return i.reject("no parameter provided");return e.post("/api/permission",{listArray:t}).then(function(e){var t=e.data;return t.success?i.resolve("access granted"):i.reject("access denied")}).catch(function(e){return i.reject("access denied")})},this.isAdmin=function(e){return e&&e.isAdmin?i.resolve():i.reject("access denied")}}]).directive("legalpid",["myValidation",function(e){return{require:"ngModel",link:function(t,i,r,n){n.$validators.legalpid=function(t,i){return!n.$isEmpty(t)&&e.checkPID(i)}}}}])}();