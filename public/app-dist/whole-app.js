!function(){"use strict";angular.module("mainApp",["ngAnimate","ui.router","ui.bootstrap","ngCart","LocalStorageModule","ngFileUpload"]).constant("appRootPath",("production"===locals.env?locals.appRootPath="/app-min/":locals.appRootPath="/app/",locals.appRootPath)).constant("cachedFarmersKey","mainApp:cachedFarmers"),angular.module("mainApp").config(["appRootPath","$stateProvider","$urlRouterProvider","localStorageServiceProvider",function(e,t,r,a){t.state({name:"home",templateUrl:e+"home/index.html",controller:"HomeCtrler as ctrler",url:"/"}).state({name:"farmer",templateUrl:e+"farmer/index.html",url:"/farmer"}).state({name:"farmerRegister",templateUrl:e+"farmer/register.html",url:"/farmer/register",controller:"FarmerPageCtrler as ctrler",resolve:{condition1:["myValidation",function(e){return e.checkPermission([{listName:"Farmer",opName:"create"}])}]}}).state({name:"farmerSearch",templateUrl:e+"farmer/search.html",url:"/farmer/search",controller:"FarmerPageCtrler as ctrler",resolve:{condition1:["myValidation",function(e){return e.checkPermission([{listName:"Farmer",opName:"read"}])}]}}).state({name:"farmerDetail",templateUrl:e+"farmer/detail.html",url:"/farmer/detail",params:{farmerPID:null},controller:"AccountPageCtrler as ctrler",resolve:{condition1:["myValidation",function(e){return e.checkPermission([{listName:"Farmer",opName:"read"},{listName:"Account",opName:"read"},{listName:"AccountRecord",opName:"read"}])}]}}).state({name:"product",templateUrl:e+"product/index.html",url:"/product"}).state({name:"productSell",templateUrl:e+"product/sell.html",url:"/product/sell",controller:"ProductPageCtrler as ctrler",resolve:{condition1:["myValidation",function(e){return e.checkPermission([{listName:"Product",opName:"read"},{listName:"Farmer",opName:"read"},{listName:"Account",opName:["read","update"]},{listName:"AccountRecord",opName:"create"},{listName:"Transaction",opName:"create"}])}]}}).state({name:"productManage",templateUrl:e+"product/manage.html",url:"/product/manage",controller:"ProductPageCtrler as ctrler",resolve:{condition1:["myValidation",function(e){return e.checkPermission([{listName:"Product",opName:["create","read","update","delete"]},{listName:"ProductType",opName:["create","read","update","delete"]}])}]}}).state({name:"statistics",templateUrl:e+"statistics/index.html",url:"/statistics"}).state({name:"transStatisData",templateUrl:e+"statistics/transaction-list.html",url:"/statistics/transaction",controller:"TransListPageCtrler as ctrler",resolve:{condition1:["myValidation",function(e){return e.checkPermission([{listName:"Transaction",opName:"read"},{listName:"AccountRecord",opName:"read"}])}]}}).state({name:"accRecStatisData",templateUrl:e+"statistics/acc-rec-aggregate.html",url:"/statistics/acc-rec-aggregate",controller:"AccRecAggPageCtrler as ctrler",resolve:{condition1:["myValidation",function(e){return e.checkPermission([{listName:"Transaction",opName:"read"},{listName:"AccountRecord",opName:"read"}])}]}}).state({name:"admin",templateUrl:e+"admin/index.html",url:"/admin-front",resolve:{condition1:["myValidation",function(e){return e.isAdmin(locals.user)}]}}).state({name:"adminAnnuallyWithdraw",templateUrl:e+"admin/annually-withdraw.html",url:"/admin-front/annually-withdraw",controller:"AnnuallyWithdrawPageCtrler as ctrler",resolve:{condition1:["myValidation",function(e){return e.isAdmin(locals.user)}]}}).state({name:"403",templateUrl:e+"error/403.html",url:"/error/403"}).onInvalid(function(e,t){return console.log("invalid state from ",t," to ",e),!1}),r.otherwise("/"),a.setPrefix("mainApp").setNotify(!1,!1)}]).run(["$state","$window","$http","$uibModal","$rootScope","$transitions","myValidation","cachedFarmersKey","appRootPath",function(e,t,r,a,o,n,l,i,c){console.log("config end, angular app start to run"),o.locals=locals,o.alerts=[],o.pubSuccessMsg=function(e){o.alerts.push({type:"success",msg:e})},o.pubWarningMsg=function(e){o.alerts.push({type:"warning",msg:e})},o.pubInfoMsg=function(e){o.alerts.push({type:"info",msg:e})},o.pubErrorMsg=function(e){o.alerts.push({type:"danger",msg:e})},o.isLogin=function(){return locals.user},o.isPage=function(t){return e.current.name===t},o.openShopCart=function(){o.productPageCtrler&&o.productPageCtrler.openShopCart()},o.openProductEdit=function(){o.productPageCtrler&&o.productPageCtrler.openProductEditModal()},o.openProductTypeEdit=function(){o.productTypePageCtrler&&o.productTypePageCtrler.openEditModal()},o.openCachedFarmerList=function(){var e=a.open({templateUrl:c+"farmer/farmerList.html",controller:"CachedFarmerListCtrler as ctrler",size:"lg"});e.result.catch(function(){e.close()})},n.onError({},function(t){t&&("access denied"===t.error().detail&&e.go("403"))}),o.loadDone=!0}])}();
!function(){"use strict";angular.module("mainApp").controller("AnnuallyWithdrawPageCtrler",["$http","$window","$rootScope","$uibModal","lodash","localStorageService","appRootPath",function(a,t,n,e,o,c,i){var s=this,r=new Date;s.cancelAWDate=r,s.downloadAWDate=r,s.doAWDate=new Date(r.getFullYear()+"/06/30"),s.doAWDate.setHours(12,0,0,0),s.code="000",s.doAW=function(){s.isProcessing=!0,a.post("/api/account/annually-withdraw",{code:s.code,date:s.doAWDate}).then(function(a){var t=a.data;if(t.success){var e=t.filename,o=new Blob([new Uint8Array(t.content.data)],{type:"text/plain"});saveAs(o,e),s.checkCode=t.checkCode,n.pubSuccessMsg("年度結清執行成功,已下載媒體檔")}}).catch(function(a){var t=a&&a.data?a.data.toString():a?a.toString():"";n.pubErrorMsg("年度結清執行失敗,"+t)}).finally(function(){s.isProcessing=!1})},s.cancelAW=function(){s.isProcessing=!0,a.post("/api/account/cancel-annually-withdraw",{date:s.cancelAWDate}).then(function(a){s.checkCode=void 0,a.data.success&&n.pubSuccessMsg("年度結清撤銷成功")}).catch(function(a){var t=a&&a.data?a.data.toString():a?a.toString():"";n.pubErrorMsg("年度結清撤銷失敗,"+t)}).finally(function(){s.isProcessing=!1})},s.downloadAWFile=function(){s.isProcessing=!0,a.post("/api/account/gen-annually-withdraw-file",{code:s.code,date:s.downloadAWDate}).then(function(a){var t=a.data;if(t.success){var e=t.filename,o=new Blob([new Uint8Array(t.content.data)],{type:"text/plain;charset=big-5"});saveAs(o,e),n.pubSuccessMsg("年度結清媒體檔已下載")}}).catch(function(a){var t=a&&a.data?a.data.toString():a?a.toString():"";n.pubErrorMsg("年度結清媒體檔下載失敗,"+t)}).finally(function(){s.isProcessing=!1})}}])}();
!function(){"use strict";angular.module("mainApp").controller("AccountPageCtrler",["$http","$window","$state","$rootScope","$uibModal","cachedFarmersKey","lodash","localStorageService","appRootPath",function(t,e,n,r,c,a,o,i,s){var u=this;if(n.params){var l=n.params.farmerPID;l?i.set("farmerDetail:farmerPID",l):l=i.get("farmerDetail:farmerPID"),u.accountUser="",u.getDetail=function(){t.post("/api/farmer/get-and-populate",{farmerPID:l,_populate:"village"}).then(function(t){var e=t.data;e.success?(u.farmer=e.result.farmer,u.accounts=e.result.accounts):r.pubWarningMsg(e.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";r.pubErrorMsg("抓取農民存摺資訊失敗,"+e),console.log(t)})},u.createAccount=function(){t.post("/api/account/create",{farmerPID:l,accountUser:u.accountUser,comment:u.comment}).then(function(t){var e=t.data;if(e.success){!u.accounts instanceof Array&&(u.accounts=[]);var n=u.accounts.length+1;r.pubSuccessMsg("存摺"+n.toString()+"開立成功"),u.accounts.push(e.result)}else r.pubWarningMsg(e.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";r.pubErrorMsg("開立存摺失敗,"+e),console.log(t)})},u.openCreateAccountModal=function(){var t=c.open({templateUrl:"create-account.html",controller:"CreateAccountModalCtrler as $ctrl",size:"md"});t.result.then(function(t){u.accountUser=t.accountUser,u.comment=t.comment,u.createAccount()}).catch(function(){t.close()})},u.openAccountDetail=function(t){t.farmer=u.farmer;var e=c.open({templateUrl:"account-detail.html",controller:"AccountDetailModalCtrler as ctrler",size:"lg",resolve:{account:function(){return t}}});e.result.then(function(t){r.pubSuccessMsg(t)}).catch(function(){e.close()})},u.openUpdateFarmerModal=function(){var e=c.open({templateUrl:s+"farmer/update.html",controller:"UpdateFarmerModalCtrler as ctrler",size:"md",resolve:{farmer:function(){return u.farmer}}});e.result.then(function(e){e._populate="village",t.post("/api/farmer/update",e).then(function(t){var e=t.data;e.success?(r.pubSuccessMsg("更新成功,頁面資料已更新"),u.farmer=e.result):r.pubErrorMsg("更新失敗,"+e.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";r.pubErrorMsg("更新失敗,"+e)})}).catch(function(){e.close()})},u.addFarmerToCache=function(){if(u.farmer){var t=i.get(a);t||(t=[]),-1===o.findIndex(t,function(t){return t.pid===u.farmer.pid})?(t.push(u.farmer),i.set(a,t),r.pubSuccessMsg("已加入暫存列表,可用於購物車等其他服務")):r.pubErrorMsg("該農民已在暫存列表")}}}else console.log("error: no params")}]).controller("CreateAccountModalCtrler",["$uibModalInstance",function(t){var e=this;e.result={accountUser:""},e.ok=function(){t.close(e.result)},e.cancel=function(){t.dismiss("cancel")}}]).controller("AccountDetailModalCtrler",["$uibModalInstance","account","$http","lodash","$q","Upload","$window","$scope",function(t,e,n,r,c,a,o,i){var s=this;s.account=e;var u=new Date;u.setFullYear(u.getFullYear()-1,6,1),s.startDateFilter=u,s.resetOpView=function(){s.closeAcc={},s.deposit={},s.withdraw={},s.setFreeze={},s.isProcessing=!1,s.withdraw.comment=s.account.farmer.name+" 白米存摺轉出",s.withdraw.ioAccount=s.account.farmer.ioAccount,s.deposit.comment=s.account.farmer.name+" 白米存摺轉入",s.deposit.ioAccount=s.account.farmer.ioAccount},s.resetOpView(),s.alerts=[],s.pubSuccessMsg=function(t){s.alerts.push({type:"success",msg:t})},s.pubWarningMsg=function(t){s.alerts.push({type:"warning",msg:t})},s.pubInfoMsg=function(t){s.alerts.push({type:"info",msg:t})},s.pubErrorMsg=function(t){s.alerts.push({type:"danger",msg:t})};var l=function(t,e,n){r.isString(n)?n.length>0&&(t[e]=n):r.isNumber(n)&&(t[e]=n)};s.getPeriods=function(t){return n.post("/api/read",{listName:"Period",contains:{name:t},limit:8}).then(function(t){return t.data.success?t.data.result:c.reject()})},s.changeQty=function(t,e){t.qty+=e},s.rmItem=function(t){if(s.edittingRec.products){var e=r.findIndex(s.edittingRec.products,function(e){return e.pid===t.pid});-1!==e&&s.edittingRec.products.splice(e,1)}},s.getTotal=function(){if(s.edittingRec&&s.edittingRec.products){var t=0;return s.edittingRec.products.forEach(function(e){t+=e.price*e.qty}),t}return 0},s.isUpdateRecButtonDisabled=function(){return!!s.edittingRec&&("transact"===s.edittingRec.opType.value?s.isProcessing||i.accountOpForm.editRecItemQty&&i.accountOpForm.editRecItemQty.$invalid:"withdraw"===s.edittingRec.opType.value||"deposit"===s.edittingRec.opType.value?s.isProcessing||i.accountOpForm.editRecAmount.$invalid:void 0)},s.depositOp=function(){s.isProcessing=!0;var t={_id:s.account._id,amount:s.deposit.amount};l(t,"period",s.deposit.period),l(t,"comment",s.deposit.comment),l(t,"ioAccount",s.deposit.ioAccount),n.post("/api/account/deposit",t).then(function(t){var e=t.data;if(e.success){r.assign(s.account,e.result),s.resetOpView(),s.getAccountRecords();var n=s.account.lastRecord;return s.downloadDWSheetOp(n,"deposit","入款成功,頁面資料已更新")}s.pubErrorMsg("入款失敗,"+e.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";s.pubErrorMsg("入款失敗,"+e)}).finally(function(){s.isProcessing=!1})},s.withdrawOp=function(){s.isProcessing=!0;var t={_id:s.account._id,amount:s.withdraw.amount};l(t,"comment",s.withdraw.comment),l(t,"ioAccount",s.withdraw.ioAccount),n.post("/api/account/withdraw",t).then(function(t){var e=t.data;if(e.success){r.assign(s.account,e.result),s.resetOpView(),s.getAccountRecords();var n=s.account.lastRecord;return s.downloadDWSheetOp(n,"withdraw","提款成功,頁面資料已更新")}s.pubErrorMsg("提款失敗,"+e.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";s.pubErrorMsg("提款失敗,"+e)}).finally(function(){s.isProcessing=!1})},s.FileSizeLimit="1MB",s.unfreezeFileSelect=function(t,e){s.errFile=e&&e[0],"maxSize"===s.errFile.$error?s.errFile.errorChMsg="超過檔案限制 "+s.FileSizeLimit:s.errFile.errorChMsg=s.errFile.$error},s.downloadUnfreezeSheetOp=function(){s.isProcessing=!0,n.post("/pdf/unfreeze-sheet",{_id:s.account._id}).then(function(t){var e=t.data.filename,n=new Blob([new Uint8Array(t.data.content.data)],{type:"application/pdf"});saveAs(n,e),s.pubSuccessMsg("下載解凍單成功")}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";s.pubErrorMsg("下載解凍單失敗,"+e)}).finally(function(){s.isProcessing=!1})},s.setFreezeOp=function(){s.isProcessing=!0;var t={_id:s.account._id};l(t,"comment",s.setFreeze.comment);var e=new FormData;s.setFreeze.unfreezeSheet&&e.append("relatedFile",s.setFreeze.unfreezeSheet),e.append("opData",angular.toJson(t)),a.http({url:"/api/account/set-freeze",headers:{"Content-type":void 0},data:e}).then(function(t){var e=t.data;e.success?(r.assign(s.account,e.result),s.resetOpView(),s.getAccountRecords(),s.pubSuccessMsg((s.account.freeze?"凍結成功":"解凍成功")+",頁面資料已更新")):s.pubErrorMsg("失敗,"+e.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";s.pubErrorMsg("失敗,"+e)}).finally(function(){s.isProcessing=!1},function(t){s.setFreeze.uploadProgress=parseInt(100*t.loaded/t.total)})},s.closeAccOp=function(){s.isProcessing=!0;var t={_id:s.account._id};l(t,"comment",s.closeAcc.comment),n.post("/api/account/close",t).then(function(t){var e=t.data;e.success?(r.assign(s.account,e.result),s.resetOpView(),s.getAccountRecords(),s.pubSuccessMsg("結清成功,已呈現最新資料")):s.pubErrorMsg("結清失敗,"+e.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";s.pubErrorMsg("結清失敗,"+e)}).finally(function(){s.isProcessing=!1})},s.accUserChangeOp=function(){s.isProcessing=!0;var t={_id:s.account._id,newUser:s.accUserChange.newUser};l(t,"comment",s.accUserChange.comment),n.post("/api/account/change-acc-user",t).then(function(t){var e=t.data;e.success?(r.assign(s.account,e.result),s.resetOpView(),s.getAccountRecords(),s.pubSuccessMsg("過戶成功,已呈現最新資料")):s.pubErrorMsg("過戶失敗,"+e.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";s.pubErrorMsg("過戶失敗,"+e)}).finally(function(){s.isProcessing=!1})},s.cancel=function(){t.dismiss("cancel")}}]).controller("UpdateFarmerModalCtrler",["$uibModalInstance","farmer","geoDataService","$rootScope",function(t,e,n,r){var c=this;c.farmer=_.clone(e,!1),c.farmer.birth=Date.parse(c.farmer.birth),c.selectOnChange=function(t,e){return"dists"===t&&(c.distSelect=null,c.villages=null),n.fetch(t,e).then(function(e){return c[t]=e,e})};c.getCities=function(){c.selectOnChange("cities",null).then(function(t){return c.citySelect=_.find(c.cities,function(t){return t._id===c.farmer.city}),c.selectOnChange("dists",c.citySelect._id)}).then(function(t){return c.distSelect=_.find(c.dists,function(t){return t._id===c.farmer.dist}),c.selectOnChange("villages",c.distSelect._id)}).then(function(t){c.villageSelect=_.find(c.villages,function(t){return t._id===c.farmer.village._id})}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";r.pubErrorMsg("抓取地理資訊失敗,"+e),console.log(t)})},c.ok=function(){c.farmer.city=c.citySelect._id,c.farmer.dist=c.distSelect._id,c.farmer.village=c.villageSelect._id,c.hasOwnProperty("cities")&&c.hasOwnProperty("dists")&&c.citySelect&&c.distSelect?c.farmer.addr=c.citySelect.name+c.distSelect.dist+c.farmer.addrRest:c.farmer.addr="",t.close(c.farmer)},c.cancel=function(){t.dismiss("cancel")}}])}();
!function(){"use strict";angular.module("mainApp").controller("CachedFarmerListCtrler",["cachedFarmersKey","lodash","localStorageService","$state","$uibModalInstance",function(r,e,a,t,i){var s=this,n=a.get(r);s.farmers=n||[],s.rmFarmerFromList=function(t){var i=e.findIndex(s.farmers,function(r){return r.pid===t.pid});-1!==i&&(s.farmers.splice(i,1),a.set(r,s.farmers))},s.goDetailPage=function(r){a.set("farmerDetail:farmerPID",r.pid),t.go("farmerDetail"),i.dismiss()}}])}();
!function(){"use strict";angular.module("mainApp").controller("FarmerPageCtrler",["myValidation","$http","$window","$state","$rootScope","geoDataService","lodash",function(e,t,i,n,r,a,c){var s=this;s.birth=new Date(1980,0,1),s.showRegisterTable=!1,s.isRegistering=!1,s.isSearching=!1,s.selectOnChange=function(e,t){return"dists"===e&&(s.distSelect=null,s.villages=null),a.fetch(e,t).then(function(t){return s[e]=t,t}).catch(function(e){var t=e&&e.data?e.data.toString():e?e.toString():"";r.pubErrorMsg("抓取地理資訊失敗,"+t),console.log(e)})};var l=function(e){return e?e.replace(/\D+/g,""):""};s.refreshData=function(){var e;s.pid&&(s.pid=s.pid.toUpperCase()),s.hasOwnProperty("cities")&&s.hasOwnProperty("dists")&&s.citySelect&&s.distSelect?s.fullAddr=s.citySelect.name+s.distSelect.dist+s.addrRest:s.fullAddr="",s.tele1=l(s.tele1),s.tele2=l(s.tele2),s.ioAccount=(e=s.ioAccount)?e.replace(/[^A-Z0-9]/gi,""):""},s.registerFarmer=function(){var e={name:s.farmerName,pid:s.pid,birth:s.birth,teleNum1:s.tele1,teleNum2:s.tele2,city:s.citySelect._id,dist:s.distSelect._id,village:s.villageSelect._id,addrRest:s.addrRest,addr:s.fullAddr,ioAccount:s.ioAccount};s.isRegistering=!0,t.post("/api/farmer/register",e).then(function(e){var t=e.data;t.success?(console.log("register farmer success"),r.pubSuccessMsg("註冊成功,即將返回入口頁面"),setTimeout(function(){n.go("farmer")},3e3)):r.pubWarningMsg("註冊失敗,"+t.message)}).catch(function(e){var t=e&&e.data?e.data.toString():e?e.toString():"";r.pubErrorMsg("註冊失敗,"+t)}).finally(function(){s.isRegistering=!1})};s.getCities=function(){s.selectOnChange("cities",null).then(function(e){!function(e){if(r.locals){var t=r.locals.sys;s.citySelect=c.find(s.cities,function(e){return e._id===t.cityDist.city}),s.selectOnChange("dists",s.citySelect._id).then(function(i){"city"!==e&&(s.distSelect=c.find(s.dists,function(e){return e._id===t.cityDist._id}),s.selectOnChange("villages",s.distSelect._id))})}}()})},s.maxCanDisplay=50,s.search=function(){var e={name:s.farmerName&&s.farmerName.length?s.farmerName:void 0,pid:s.pid&&s.pid.length?s.pid:void 0,tele:s.tele&&s.tele.length?s.tele:void 0,city:s.citySelect?s.citySelect._id:void 0,dist:s.distSelect?s.distSelect._id:void 0,village:s.villageSelect?s.villageSelect._id:void 0,_limit:s.maxCanDisplay};s.isSearching=!0,t.post("/api/farmer/search",e).then(function(e){var t=e.data;t.success?(t.result&&0!=t.result.length||r.pubInfoMsg("無任何結果,請更改條件再行搜尋"),s.farmers=t.result,s.numTotalResult=t.total):(s.farmers=[],r.pubWarningMsg(t.message))}).catch(function(e){var t=e&&e.data?e.data.toString():e?e.toString():"";r.pubErrorMsg("搜尋失敗,"+t),console.log(e)}).finally(function(){s.isSearching=!1})}}])}();
!function(){"use strict";angular.module("mainApp").controller("HomeCtrler",["$http","$rootScope",function(o,t){}])}();