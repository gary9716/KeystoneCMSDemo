<!-- floating shopping cart
<button style="position:fixed; right:100px; top:100px;"><i class="fa fa-shopping-cart" aria-hidden="true"></i> 購物車</button>
-->
<div class="container">
  <!-- dont directly apply listTo2DMat filter to ng-repeat expression here. 
    it's unstable -->
  <div class="row" ng-repeat="productsPerRow in ctrler.products">
    <div class="col-md-4" ng-repeat="product in productsPerRow" ng-include="'product-layout-v1.html'"></div>
  </div>
</div> <!-- .container -->

<!-- templates start -->
<!-- product layout -->
<script type="text/ng-template" id="product-layout-v1.html">
  <style>
  /* hide input number's arrows */
  input[type=number]::-webkit-inner-spin-button, 
  input[type=number]::-webkit-outer-spin-button { 
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      margin: 0; 
  }
  .product-info-row {
    display: flex; align-items: center;
  }

  table.product-table {
    padding: 0;
  }

  table.product-table td {
    background-color: white;
  }

  table.product-table td.price-col {
    padding-left: 1em;
    
  }

  </style>
  
  <div class="thumbnail" style="padding: 5px 20px 20px;">
    <img ng-src="{{::product.image}}" alt="" class="img-responsive">
    <form name="pForm">
      <div class="caption">
        <h4 class="pull-right">每包重{{::product.weight}}kg</h4>
        <h4><a class="clickable" ng-click="ctrler.viewDetail()">{{::product.name}}</a></h4>
        
          <div class="form-group product-info-row">
            <label>價格方案：</label>
            <div class="col-md-8" style="padding: 5px 5px;">
              <table class="product-table table-striped table-responsive">
                <tr>
                  <td class="txt-col"><input type="radio" ng-value="product.marketPrice" ng-model="product.price" ng-model-options="{ debounce: 100 }" ng-hide="product.isInCart">定價</td> 
                  <td class="price-col">{{::product.marketPrice}}</td>
                </tr>
                <tr>
                  <td class="txt-col"><input type="radio" ng-value="product.exchangePrice" ng-model="product.price" ng-model-options="{ debounce: 100 }" ng-hide="product.isInCart">兌換價</td> 
                  <td class="price-col">{{::product.exchangePrice}}</td>
                </tr>
                <tr>
                  <td class="txt-col"><input type="radio" ng-value="product.discountPrice" ng-model="product.price" ng-model-options="{ debounce: 100 }" ng-hide="product.isInCart">折扣價</td> 
                  <td class="price-col">{{::product.discountPrice}}</td>
                </tr>
              </table>
            </div>
          </div>

          <div class="form-group product-info-row" style="min-height: 2em;">
            <label>最終價格：</label>
            <input type="number" name="price" ng-model="product.price" ng-model-options="{ debounce: 200 }" class="col-sm-4 col-md-7 text-center" ng-hide="product.isInCart" required>
            <label class="col-sm-4 col-md-7 text-center" ng-show="product.isInCart">{{product.price}} 元</label>
          </div>
          <div class="form-group product-info-row" style="min-height: 3em; margin: 10px auto;">
            <label>{{product.isInCart?'已加包數':'欲加包數'}}：</label>
            <!-- quantity selector -->
            <div class="input-group col-sm-4 col-md-7" ng-hide="product.isInCart">
              <span class="input-group-btn data-dwn">
                <button class="btn btn-default btn-info" ng-click="ctrler.changeQty(product,-1);"><span class="fa fa-minus"></span></button>
              </span>
              <input type="number" name="qty" ng-model="product.quantity" ng-model-options="{ debounce: 200 }" class="form-control text-center" min="1" required>
              <span class="input-group-btn data-up">
                <button class="btn btn-default btn-info" ng-click="ctrler.changeQty(product,1);"><span class="fa fa-plus"></span></button>
              </span>
            </div>
            <label class="col-sm-4 col-md-7 text-center" ng-show="product.isInCart">{{product.quantity}} 包</label>
          </div>
      </div>
      <div class="btn-ground text-center">
          <button ng-hide="product.isInCart" ng-click="ctrler.addItemToCart(product)" ng-disabled="pForm.$invalid" type="button" class="btn btn-primary"><i class="fa fa-shopping-cart"></i> 加到購物車</button>
          <button ng-show="product.isInCart" ng-click="ctrler.rmItemFromCart(product)" type="button" class="btn btn-danger"><i class="fa fa-times"></i> 從購物車移除</button>
      </div>
    </form>
  </div>
</script>

<!-- checkout modal -->
<script type="text/ng-template" id="cart-and-checkout.html">
<div class="form-group text-center" ng-show="ctrler.cartEmpty()">
<h3>購物車目前是空的</h3>
<button type="button" class="btn btn-primary" ng-click="ctrler.cancel()">關閉</button>
</div>
<form name="cartForm" class="row" ng-hide="ctrler.cartEmpty()">
    <div class="col-sm-12 col-md-10 col-md-offset-1">
        <table class="table">
            <thead>
                <tr>
                    <th>商品</th>
                    <th>數量</th>
                    <th class="text-center">單價</th>
                    <th class="text-center">總價</th>
                    <th> </th>
                </tr>
            </thead>
            <tbody>
                <tr ng-repeat="item in ctrler.getCartItems() track by item._id">
                    <td class="col-sm-8 col-md-6">
                      <div class="media">
                          <img class="img-responsive pull-left" ng-src="{{::item.image}}" alt="" style="max-width: 100px; max-height: 100px;">
                          <div class="media-body">
                              <h4 class="media-heading">{{::item.name}}</h4>
                              <span>每包重: {{::item.weight}} kg</span>
                          </div>
                      </div>
                    </td>
                    
                    <td class="col-sm-1 col-md-1 text-center">
                    <input type="number" class="form-control" ng-model="item.quantity" ng-model-options="{  allowInvalid: false, debounce: 200 }" ng-change="ctrler.saveCart()" required>
                    </td>
                    
                    <td class="col-sm-1 col-md-1 text-center">
                    <strong>{{::item.price}}</strong>
                    </td>
                    
                    <td class="col-sm-1 col-md-1 text-center">
                    <strong>{{item.getTotal()}}</strong>
                    </td>

                    <td class="col-sm-1 col-md-1">
                    <button ng-click="ctrler.rmItemFromCart(item)" type="button" class="btn btn-danger"><i class="fa fa-times"></i> 從購物車移除</button>
                    </td>
                </tr>
                
                <tr>
                    <td>   </td>
                    <td>   </td>
                    <td>   </td>
                    <td><h3>合計</h3></td>
                    <td class="text-right"><h3><strong>{{ctrler.getTotalPrice()}}元</strong></h3></td>
                </tr>
                <tr>
                    <td>   </td>
                    <td>   </td>
                    <td>   </td>
                    <td>
                    <button type="button" class="btn btn-primary" ng-click="ctrler.cancel()">
                        <span class="fa fa-shopping-cart"></span> 繼續購物
                    </button></td>
                    <td>
                    <button type="button" class="btn btn-success" ng-disabled="cartForm.$invalid" ng-click="ctrler.checkout()">
                        結帳 <span class="fa fa-play"></span>
                    </button></td>
                </tr>
            </tbody>
        </table>
    </div>
</form>
</script>
<!-- templates end -->