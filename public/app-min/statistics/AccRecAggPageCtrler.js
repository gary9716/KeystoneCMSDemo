!function(){"use strict";angular.module("mainApp").controller("AccRecAggPageCtrler",["$http","$window","$state","$rootScope","lodash","localStorageService","$uibModal",function(a,e,t,g,n,c,r){var o=this;o.pubSuccessMsg=function(a){g.pubSuccessMsg(a)},o.pubWarningMsg=function(a){g.pubWarningMsg(a)},o.pubInfoMsg=function(a){g.pubInfoMsg(a)},o.pubErrorMsg=function(a){g.pubErrorMsg(a)},o.setAggregateResult=function(a){var e={};a.countOpTypeAndSumAmount.forEach(function(a){e[a._id]=a}),["create","close","freeze","unfreeze","deposit","withdraw","transact","accUserChange","annuallyWithdraw"].forEach(function(a){e[a]||(e[a]={_id:a,count:0,amount:0})});var t={};["all","freeze","unfreeze"].forEach(function(a){t[a]={count:0,balance:0}}),a.aggAcc.forEach(function(a){a._id.freeze?(t.freeze.count+=a.count,t.freeze.balance+=a.balance):(t.unfreeze.count+=a.count,t.unfreeze.balance+=a.balance),t.all.count+=a.count,t.all.balance+=a.balance}),o.aggregateData.accAgg=t,o.aggregateData.accRecsAgg=e},o.aggregateAccRecs=function(e){o.isAggregating=!0,o.aggregateData||(o.aggregateData={}),delete o.aggregateData.accAgg,delete o.aggregateData.accRecsAgg,o.aggregateData.startDate=o.filters.date&&n.isDate(o.filters.date.$gte)?new Date(o.filters.date.$gte):void 0,o.aggregateData.endDate=o.filters.date&&n.isDate(o.filters.date.$lt)?new Date(o.filters.date.$lt):void 0,o.aggregateData.endDate&&o.aggregateData.endDate.setHours(-24,0,0,0),a.post("/api/account-rec/aggregate",{filters:o.filters}).then(function(a){var e=a.data;e.success&&(o.setAggregateResult(e.result),o.pubSuccessMsg("統計成功"))}).catch(function(a){var e=a&&a.data?a.data.toString():a?a.toString():"";o.pubErrorMsg("統計失敗,"+e)}).finally(function(){o.isAggregating=!1})},o.downloadAccRecsAggInfoPDF=function(e){o.isDownloading=!0,a.post("/pdf/acc-recs-aggregate",{tag:e,startDate:o.aggregateData.startDate,endDate:o.aggregateData.endDate,accRecsAgg:o.aggregateData.accRecsAgg,accAgg:o.aggregateData.accAgg}).then(function(a){var t=a.data.filename,g=new Blob([new Uint8Array(a.data.content.data)],{type:"application/pdf"});saveAs(g,t),"all"===e?o.pubSuccessMsg("下載交易匯總統計表成功"):o.pubSuccessMsg("下載年度結清總表成功")}).catch(function(a){var t=a&&a.data?a.data.toString():a?a.toString():"";"all"===e?o.pubErrorMsg("下載交易匯總統計表失敗,"+t):o.pubErrorMsg("下載年度結清總表失敗,"+t)}).finally(function(){o.isDownloading=!1})}}])}();