!function(){"use strict";angular.module("mainApp").controller("AccRecAggPageCtrler",["$http","$window","$state","$rootScope","lodash","localStorageService","$uibModal",function(a,t,e,n,g,c,r){var o=this;o.pubSuccessMsg=function(a){n.pubSuccessMsg(a)},o.pubWarningMsg=function(a){n.pubWarningMsg(a)},o.pubInfoMsg=function(a){n.pubInfoMsg(a)},o.pubErrorMsg=function(a){n.pubErrorMsg(a)},o.setAggregateResult=function(a){var t={};a.countOpTypeAndSumAmount.forEach(function(a){t[a._id]=a}),["create","close","freeze","unfreeze","deposit","withdraw","transact","accUserChange","annuallyWithdraw"].forEach(function(a){t[a]||(t[a]={_id:a,count:0,amount:0})}),t.withdraw.count+=t.annuallyWithdraw.count,t.withdraw.amount+=t.annuallyWithdraw.amount;var e={};["all","freeze","unfreeze"].forEach(function(a){e[a]={count:0,balance:0}}),a.aggAcc.forEach(function(a){a._id.freeze?(e.freeze.count+=a.count,e.freeze.balance+=a.balance):(e.unfreeze.count+=a.count,e.unfreeze.balance+=a.balance),e.all.count+=a.count,e.all.balance+=a.balance}),o.aggregateData.accAgg=e,o.aggregateData.accRecsAgg=t},o.aggregateAccRecs=function(){o.isAggregating=!0,o.aggregateData={},o.aggregateData.startDate=o.filters.date&&g.isDate(o.filters.date.$gte)?new Date(o.filters.date.$gte):void 0,o.aggregateData.endDate=o.filters.date&&g.isDate(o.filters.date.$lt)?new Date(o.filters.date.$lt):void 0,o.aggregateData.endDate&&o.aggregateData.endDate.setHours(-24,0,0,0),a.post("/api/account-rec/aggregate",{filters:o.filters}).then(function(a){var t=a.data;t.success&&(o.setAggregateResult(t.result),o.pubSuccessMsg("統計成功"))}).catch(function(a){var t=a&&a.data?a.data.toString():a?a.toString():"";o.pubErrorMsg("統計失敗,"+t)}).finally(function(){o.isAggregating=!1})},o.downloadAccRecsAggInfoPDF=function(){o.isDownloading=!0,a.post("/pdf/acc-recs-aggregate",{startDate:o.aggregateData.startDate,endDate:o.aggregateData.endDate,accRecsAgg:o.aggregateData.accRecsAgg,accAgg:o.aggregateData.accAgg}).then(function(a){var t=a.data.filename,e=new Blob([new Uint8Array(a.data.content.data)],{type:"application/pdf"});saveAs(e,t),o.pubSuccessMsg("下載兌領統計表成功")}).catch(function(a){var t=a&&a.data?a.data.toString():a?a.toString():"";o.pubErrorMsg("下載兌領統計表失敗,"+t)}).finally(function(){o.isDownloading=!1})}}])}();