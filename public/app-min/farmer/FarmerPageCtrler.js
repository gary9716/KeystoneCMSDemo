!function(){"use strict";angular.module("mainApp").controller("FarmerPageCtrler",["myValidation","$http","$window","$state","$rootScope","geoDataService","lodash",function(e,t,i,n,r,a,c){var s=this;s.birth=new Date(1980,0,1),s.showRegisterTable=!1,s.isRegistering=!1,s.isSearching=!1,s.selectOnChange=function(e,t){return"dists"===e&&(s.distSelect=null,s.villages=null),a.fetch(e,t).then(function(t){return s[e]=t,t}).catch(function(e){var t=e&&e.data?e.data.toString():e?e.toString():"";r.pubErrorMsg("抓取地理資訊失敗,"+t),console.log(e)})};var l=function(e){return e?e.replace(/\D+/g,""):""};s.refreshData=function(){var e;s.pid&&(s.pid=s.pid.toUpperCase()),s.hasOwnProperty("cities")&&s.hasOwnProperty("dists")&&s.citySelect&&s.distSelect?s.fullAddr=s.citySelect.name+s.distSelect.dist+s.addrRest:s.fullAddr="",s.tele1=l(s.tele1),s.tele2=l(s.tele2),s.ioAccount=(e=s.ioAccount)?e.replace(/[^A-Z0-9]/gi,""):""},s.registerFarmer=function(){var e={name:s.farmerName,pid:s.pid,birth:s.birth,teleNum1:s.tele1,teleNum2:s.tele2,city:s.citySelect._id,dist:s.distSelect._id,village:s.villageSelect._id,addrRest:s.addrRest,addr:s.fullAddr,ioAccount:s.ioAccount};s.isRegistering=!0,t.post("/api/farmer/register",e).then(function(e){var t=e.data;t.success?(console.log("register farmer success"),r.pubSuccessMsg("註冊成功,即將返回入口頁面"),setTimeout(function(){n.go("farmer")},3e3)):r.pubWarningMsg("註冊失敗,"+t.message)}).catch(function(e){var t=e&&e.data?e.data.toString():e?e.toString():"";r.pubErrorMsg("註冊失敗,"+t)}).finally(function(){s.isRegistering=!1})};s.getCities=function(){s.selectOnChange("cities",null).then(function(e){!function(e){if(r.locals){var t=r.locals.sys;s.citySelect=c.find(s.cities,function(e){return e._id===t.cityDist.city}),s.selectOnChange("dists",s.citySelect._id).then(function(i){"city"!==e&&(s.distSelect=c.find(s.dists,function(e){return e._id===t.cityDist._id}),s.selectOnChange("villages",s.distSelect._id))})}}()})},s.maxCanDisplay=50,s.search=function(){var e={name:s.farmerName&&s.farmerName.length?s.farmerName:void 0,pid:s.pid&&s.pid.length?s.pid:void 0,tele:s.tele&&s.tele.length?s.tele:void 0,city:s.citySelect?s.citySelect._id:void 0,dist:s.distSelect?s.distSelect._id:void 0,village:s.villageSelect?s.villageSelect._id:void 0,_limit:s.maxCanDisplay};s.isSearching=!0,t.post("/api/farmer/search",e).then(function(e){var t=e.data;t.success?(t.result&&0!=t.result.length||r.pubInfoMsg("無任何結果,請更改條件再行搜尋"),s.farmers=t.result,s.numTotalResult=t.total):(s.farmers=[],r.pubWarningMsg(t.message))}).catch(function(e){var t=e&&e.data?e.data.toString():e?e.toString():"";r.pubErrorMsg("搜尋失敗,"+t),console.log(e)}).finally(function(){s.isSearching=!1})}}])}();