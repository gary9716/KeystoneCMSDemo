!function(){"use strict";angular.module("mainApp").controller("AccountPageCtrler",["$http","$window","$state","$rootScope","$uibModal","cachedFarmersKey","lodash","localStorageService","appRootPath",function(t,e,n,r,c,a,o,i,s){var u=this;if(n.params){var l=n.params.farmerPID;l?i.set("farmerDetail:farmerPID",l):l=i.get("farmerDetail:farmerPID"),u.accountUser="",u.getDetail=function(){t.post("/api/farmer/get-and-populate",{farmerPID:l,_populate:"village"}).then(function(t){var e=t.data;e.success?(u.farmer=e.result.farmer,u.accounts=e.result.accounts):r.pubWarningMsg(e.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";r.pubErrorMsg("抓取農民存摺資訊失敗,"+e),console.log(t)})},u.createAccount=function(){t.post("/api/account/create",{farmerPID:l,accountUser:u.accountUser,comment:u.comment}).then(function(t){var e=t.data;if(e.success){!u.accounts instanceof Array&&(u.accounts=[]);var n=u.accounts.length+1;r.pubSuccessMsg("存摺"+n.toString()+"開立成功"),u.accounts.push(e.result)}else r.pubWarningMsg(e.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";r.pubErrorMsg("開立存摺失敗,"+e),console.log(t)})},u.openCreateAccountModal=function(){var t=c.open({templateUrl:"create-account.html",controller:"CreateAccountModalCtrler as $ctrl",size:"md"});t.result.then(function(t){u.accountUser=t.accountUser,u.comment=t.comment,u.createAccount()}).catch(function(){t.close()})},u.openAccountDetail=function(t){t.farmer=u.farmer;var e=c.open({templateUrl:"account-detail.html",controller:"AccountDetailModalCtrler as ctrler",size:"lg",resolve:{account:function(){return t}}});e.result.then(function(t){r.pubSuccessMsg(t)}).catch(function(){e.close()})},u.openUpdateFarmerModal=function(){var e=c.open({templateUrl:s+"farmer/update.html",controller:"UpdateFarmerModalCtrler as ctrler",size:"md",resolve:{farmer:function(){return u.farmer}}});e.result.then(function(e){e._populate="village",t.post("/api/farmer/update",e).then(function(t){var e=t.data;e.success?(r.pubSuccessMsg("更新成功,頁面資料已更新"),u.farmer=e.result):r.pubErrorMsg("更新失敗,"+e.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";r.pubErrorMsg("更新失敗,"+e)})}).catch(function(){e.close()})},u.addFarmerToCache=function(){if(u.farmer){var t=i.get(a);t||(t=[]),-1===o.findIndex(t,function(t){return t.pid===u.farmer.pid})?(t.push(u.farmer),i.set(a,t),r.pubSuccessMsg("已加入暫存列表,可用於購物車等其他服務")):r.pubErrorMsg("該農民已在暫存列表")}}}else console.log("error: no params")}]).controller("CreateAccountModalCtrler",["$uibModalInstance",function(t){var e=this;e.result={accountUser:""},e.ok=function(){t.close(e.result)},e.cancel=function(){t.dismiss("cancel")}}]).controller("AccountDetailModalCtrler",["$uibModalInstance","account","$http","lodash","$q","Upload","$window","$scope",function(t,e,n,r,c,a,o,i){var s=this;s.account=e;var u=new Date;u.setFullYear(u.getFullYear()-1,6,1),s.startDateFilter=u,s.resetOpView=function(){s.closeAcc={},s.deposit={},s.withdraw={},s.setFreeze={},s.isProcessing=!1,s.withdraw.comment=s.account.farmer.name+" 白米存摺轉出",s.withdraw.ioAccount=s.account.farmer.ioAccount,s.deposit.comment=s.account.farmer.name+" 白米存摺轉入",s.deposit.ioAccount=s.account.farmer.ioAccount},s.resetOpView(),s.alerts=[],s.pubSuccessMsg=function(t){s.alerts.push({type:"success",msg:t})},s.pubWarningMsg=function(t){s.alerts.push({type:"warning",msg:t})},s.pubInfoMsg=function(t){s.alerts.push({type:"info",msg:t})},s.pubErrorMsg=function(t){s.alerts.push({type:"danger",msg:t})};var l=function(t,e,n){r.isString(n)?n.length>0&&(t[e]=n):r.isNumber(n)&&(t[e]=n)};s.getPeriods=function(t){return n.post("/api/read",{listName:"Period",contains:{name:t},limit:8}).then(function(t){return t.data.success?t.data.result:c.reject()})},s.changeQty=function(t,e){t.qty+=e},s.rmItem=function(t){if(s.edittingRec.products){var e=r.findIndex(s.edittingRec.products,function(e){return e.pid===t.pid});-1!==e&&s.edittingRec.products.splice(e,1)}},s.getTotal=function(){if(s.edittingRec&&s.edittingRec.products){var t=0;return s.edittingRec.products.forEach(function(e){t+=e.price*e.qty}),t}return 0},s.isUpdateRecButtonDisabled=function(){return!!s.edittingRec&&("transact"===s.edittingRec.opType.value?s.isProcessing||i.accountOpForm.editRecItemQty&&i.accountOpForm.editRecItemQty.$invalid:"withdraw"===s.edittingRec.opType.value||"deposit"===s.edittingRec.opType.value?s.isProcessing||i.accountOpForm.editRecAmount.$invalid:void 0)},s.depositOp=function(){s.isProcessing=!0;var t={_id:s.account._id,amount:s.deposit.amount};l(t,"period",s.deposit.period),l(t,"comment",s.deposit.comment),l(t,"ioAccount",s.deposit.ioAccount),n.post("/api/account/deposit",t).then(function(t){var e=t.data;if(e.success){r.assign(s.account,e.result),s.resetOpView(),s.getAccountRecords();var n=s.account.lastRecord;return s.downloadDWSheetOp(n,"deposit","入款成功,頁面資料已更新")}s.pubErrorMsg("入款失敗,"+e.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";s.pubErrorMsg("入款失敗,"+e)}).finally(function(){s.isProcessing=!1})},s.withdrawOp=function(){s.isProcessing=!0;var t={_id:s.account._id,amount:s.withdraw.amount};l(t,"comment",s.withdraw.comment),l(t,"ioAccount",s.withdraw.ioAccount),n.post("/api/account/withdraw",t).then(function(t){var e=t.data;if(e.success){r.assign(s.account,e.result),s.resetOpView(),s.getAccountRecords();var n=s.account.lastRecord;return s.downloadDWSheetOp(n,"withdraw","提款成功,頁面資料已更新")}s.pubErrorMsg("提款失敗,"+e.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";s.pubErrorMsg("提款失敗,"+e)}).finally(function(){s.isProcessing=!1})},s.FileSizeLimit="1MB",s.unfreezeFileSelect=function(t,e){s.errFile=e&&e[0],"maxSize"===s.errFile.$error?s.errFile.errorChMsg="超過檔案限制 "+s.FileSizeLimit:s.errFile.errorChMsg=s.errFile.$error},s.downloadUnfreezeSheetOp=function(){s.isProcessing=!0,n.post("/pdf/unfreeze-sheet",{_id:s.account._id}).then(function(t){var e=t.data.filename,n=new Blob([new Uint8Array(t.data.content.data)],{type:"application/pdf"});saveAs(n,e),s.pubSuccessMsg("下載解凍單成功")}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";s.pubErrorMsg("下載解凍單失敗,"+e)}).finally(function(){s.isProcessing=!1})},s.setFreezeOp=function(){s.isProcessing=!0;var t={_id:s.account._id};l(t,"comment",s.setFreeze.comment);var e=new FormData;s.setFreeze.unfreezeSheet&&e.append("relatedFile",s.setFreeze.unfreezeSheet),e.append("opData",angular.toJson(t)),a.http({url:"/api/account/set-freeze",headers:{"Content-type":void 0},data:e}).then(function(t){var e=t.data;e.success?(r.assign(s.account,e.result),s.resetOpView(),s.getAccountRecords(),s.pubSuccessMsg((s.account.freeze?"凍結成功":"解凍成功")+",頁面資料已更新")):s.pubErrorMsg("失敗,"+e.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";s.pubErrorMsg("失敗,"+e)}).finally(function(){s.isProcessing=!1},function(t){s.setFreeze.uploadProgress=parseInt(100*t.loaded/t.total)})},s.closeAccOp=function(){s.isProcessing=!0;var t={_id:s.account._id};l(t,"comment",s.closeAcc.comment),n.post("/api/account/close",t).then(function(t){var e=t.data;e.success?(r.assign(s.account,e.result),s.resetOpView(),s.getAccountRecords(),s.pubSuccessMsg("結清成功,已呈現最新資料")):s.pubErrorMsg("結清失敗,"+e.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";s.pubErrorMsg("結清失敗,"+e)}).finally(function(){s.isProcessing=!1})},s.accUserChangeOp=function(){s.isProcessing=!0;var t={_id:s.account._id,newUser:s.accUserChange.newUser};l(t,"comment",s.accUserChange.comment),n.post("/api/account/change-acc-user",t).then(function(t){var e=t.data;e.success?(r.assign(s.account,e.result),s.resetOpView(),s.getAccountRecords(),s.pubSuccessMsg("過戶成功,已呈現最新資料")):s.pubErrorMsg("過戶失敗,"+e.message)}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";s.pubErrorMsg("過戶失敗,"+e)}).finally(function(){s.isProcessing=!1})},s.cancel=function(){t.dismiss("cancel")}}]).controller("UpdateFarmerModalCtrler",["$uibModalInstance","farmer","geoDataService","$rootScope",function(t,e,n,r){var c=this;c.farmer=_.clone(e,!1),c.farmer.birth=Date.parse(c.farmer.birth),c.selectOnChange=function(t,e){return"dists"===t&&(c.distSelect=null,c.villages=null),n.fetch(t,e).then(function(e){return c[t]=e,e})};c.getCities=function(){c.selectOnChange("cities",null).then(function(t){return c.citySelect=_.find(c.cities,function(t){return t._id===c.farmer.city}),c.selectOnChange("dists",c.citySelect._id)}).then(function(t){return c.distSelect=_.find(c.dists,function(t){return t._id===c.farmer.dist}),c.selectOnChange("villages",c.distSelect._id)}).then(function(t){c.villageSelect=_.find(c.villages,function(t){return t._id===c.farmer.village._id})}).catch(function(t){var e=t&&t.data?t.data.toString():t?t.toString():"";r.pubErrorMsg("抓取地理資訊失敗,"+e),console.log(t)})},c.ok=function(){c.farmer.city=c.citySelect._id,c.farmer.dist=c.distSelect._id,c.farmer.village=c.villageSelect._id,c.hasOwnProperty("cities")&&c.hasOwnProperty("dists")&&c.citySelect&&c.distSelect?c.farmer.addr=c.citySelect.name+c.distSelect.dist+c.farmer.addrRest:c.farmer.addr="",t.close(c.farmer)},c.cancel=function(){t.dismiss("cancel")}}])}();