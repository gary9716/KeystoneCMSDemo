!function(){"use strict";angular.module("mainApp").controller("AccRecListCtrler",["$http","lodash","$window","$uibModal",function(e,t,c,a){var n=this;n.$onInit=function(){n.curPage=1,n.refreshAccRecs=n.getAccountRecords,n.updateRecFunc=n.updateRecOp,n.downloadDWSheetFunc=n.downloadDWSheetOp,n.initDateFilter(),n.filterChange()};var r={any:"任何",transact:"兌換",deposit:"入款",withdraw:"提款",close:"結清",freeze:"凍結",unfreeze:"解凍",create:"開戶",accUserChange:"過戶",annuallyWithdraw:"年度結清"};n.opTypes=[];for(let e in r)n.opTypes.push({name:r[e],value:e});n.initDateFilter=function(){var e=new Date;e.setHours(0,0,0,0),t.isDate(n.startDateFilter)||(n.startDateFilter=e),t.isDate(n.endDateFilter)||(n.endDateFilter=e),n.applyDateFilter=!0},n.getAccountRecords=function(){e.post("/api/read",{listName:"AccountRecord",filters:n.filters,sort:"-date",populate:"operator period account",select:"opType account amount date operator comment period ioAccount transaction",page:n.curPage,perPage:n.perPage}).then(function(e){var t=e.data;t.success?(t.result.forEach(function(e){e.opType={name:r[e.opType],value:e.opType}}),n.accountRecs=t.result,n.totalAccRecs=t.total,n.getAccRecSuccessCB&&n.getAccRecSuccessCB({accRecs:n.accountRecs,totalCount:n.totalAccRecs})):n.getAccRecErrorCB&&n.getAccRecErrorCB({msg:"讀取操作記錄失敗,"+t.message})}).catch(function(e){var t=e&&e.data?e.data.toString():e?e.toString():"";n.getAccRecErrorCB&&n.getAccRecErrorCB({msg:"讀取操作記錄失敗,"+t})})},n.opTypeFilterSelected=function(){n.opTypeFilter&&"any"!==n.opTypeFilter&&(n.applyOpTypeFilter=!0)},n.datePickerChange=function(){(t.isDate(n.endDateFilter)||t.isDate(n.startDateFilter))&&(n.applyDateFilter=!0)},n.filterChange=function(){var e={};if(n.account&&(e.account=n.account._id),n.applyOpTypeFilter&&n.opTypeFilter&&"any"!==n.opTypeFilter&&(e.opType=n.opTypeFilter),t.isDate(n.endDateFilter)&&n.endDateFilter<n.startDateFilter&&(n.endDateFilter=n.startDateFilter),n.applyDateFilter)if(t.isDate(n.startDateFilter)){var c=new Date(n.startDateFilter);if(c.setHours(0,0,0,0),t.isDate(n.endDateFilter))(a=new Date(n.endDateFilter)).setHours(24,0,0,0),e.date={$gte:c,$lt:a};else e.date={$gte:c}}else if(t.isDate(n.endDateFilter)){var a;(a=new Date(n.endDateFilter)).setHours(24,0,0,0),e.date={$lt:a}}n.filters=e,n.getAccountRecords()},n.isActCountZero=function(e){var t=e.opType.value;return"freeze"===t||"unfreeze"===t||"create"===t||"accUserChange"===t},n.hasAct=function(e,t){var c=e.opType.value;return"freeze"!==c&&"unfreeze"!==c&&"create"!==c&&"accUserChange"!==c&&("transact"===c?"delete"===t||"update"===t||"detail"===t:"close"===c||"annuallyWithdraw"===c?"delete"===t:"deposit"===c||"withdraw"===c?"delete"===t||"download"===t||"update"===t:void 0)},n.deleteRec=function(a){c.confirm("即將刪除此記錄, 確定嗎")&&e.post("/api/account-rec/delete",a).then(function(e){var c=e.data;c.success&&(n.deleteAccRecSuccessCB&&n.deleteAccRecSuccessCB({msg:"刪除紀錄成功,已更新畫面"}),n.edittingRec&&a._id===n.edittingRec._id&&(n.edittingRec=void 0),n.account&&t.assign(n.account,c.result),n.getAccountRecords())}).catch(function(e){var t=e&&e.data?e.data.toString():e?e.toString():"";n.deleteAccRecErrorCB&&n.deleteAccRecErrorCB({msg:"刪除紀錄失敗,"+t})})},n.selectEdittingRec=function(c,a){n.edittingRec=t.clone(c),"transact"===n.edittingRec.opType.value?e.post("/api/read/",{listName:"Transaction",filters:{_id:c.transaction}}).then(function(e){var t=e.data;t.success&&(n.edittingRec.products=t.result[0].products)}).catch(function(e){var t=e&&e.data?e.data.toString():e?e.toString():"";n.getTransErrorCB&&n.getTransErrorCB({msg:"抓取兌領紀錄失敗,"+t})}):n.edittingRec.period=n.edittingRec.period?n.edittingRec.period.name:n.edittingRec.period,n.edittingRec.readOnly=a,n.accountOp="update-rec","modal"===n.accRecEditMode&&n.openAccRecEditModal()},n.updateRecOp=function(){var c=n.edittingRec;"transact"!==c.opType.value||c.products&&0!==c.products.length?(n.isProcessing=!0,e.post("/api/account-rec/update",c).then(function(e){var c=e.data;c.success&&(n.account&&t.assign(n.account,c.result.account),n.getAccountRecords(),n.edittingRec=void 0,n.updateAccRecSuccessCB&&n.updateAccRecSuccessCB({msg:"更新存摺紀錄成功,已更新畫面"}))}).catch(function(e){var t=e&&e.data?e.data.toString():e?e.toString():"";n.updateAccRecErrorCB&&n.updateAccRecErrorCB({msg:"更新存摺紀錄失敗,"+t})}).finally(function(){n.isProcessing=!1})):n.updateAccRecErrorCB&&n.updateAccRecErrorCB({msg:"產品列表不能為空的,不然就請刪除此紀錄"})},n.downloadDWSheetOp=function(t,c,a){return n.isProcessing=!0,e.post("/pdf/deposit-withdraw-sheet",{op:c,_id:t._id?t._id:t}).then(function(e){var t=e.data.filename,c=new Blob([new Uint8Array(e.data.content.data)],{type:"application/pdf"});saveAs(c,t),n.downloadDWSheetSuccessCB&&(a?n.downloadDWSheetSuccessCB({msg:a+",轉帳單已下載"}):n.downloadDWSheetSuccessCB({msg:"下載轉帳單成功"}))}).catch(function(e){var t=e&&e.data?e.data.toString():e?e.toString():"";n.downloadDWSheetErrorCB&&n.downloadDWSheetErrorCB({msg:"下載轉帳單失敗,"+t})}).finally(function(){n.isProcessing=!1})},n.downloadRecPDF=function(e){"withdraw"!==e.opType.value&&"deposit"!==e.opType.value||n.downloadDWSheetOp(e,e.opType.value)},n.openAccRecEditModal=function(){var e="transact"===n.edittingRec.opType.value?"lg":"md",t=a.open({templateUrl:"acc-rec-edit.html",controller:"AccRecEditModalCtrler as ctrler",size:e,resolve:{accRec:function(){return n.edittingRec}}});t.result.then(function(){n.updateRecOp()}).catch(function(){n.edittingRec=void 0,t.close()})}}]).controller("AccRecEditModalCtrler",["$uibModalInstance","accRec","$scope","$http",function(e,t,c,a){var n=this;n.edittingRec=t,n.isModalMode=!0,n.getPeriods=function(e){return a.post("/api/read",{listName:"Period",contains:{name:e},limit:8}).then(function(e){return e.data.success?e.data.result:$q.reject()})},n.changeQty=function(e,t){e.qty+=t},n.rmItem=function(e){if(n.edittingRec.products){var t=_.findIndex(n.edittingRec.products,function(t){return t.pid===e.pid});-1!==t&&n.edittingRec.products.splice(t,1)}},n.getTotal=function(){if(n.edittingRec&&n.edittingRec.products){var e=0;return n.edittingRec.products.forEach(function(t){e+=t.price*t.qty}),e}return 0},n.isUpdateRecButtonDisabled=function(){return!!n.edittingRec&&("transact"===n.edittingRec.opType.value?n.isProcessing||c.accountOpForm.editRecItemQty&&c.accountOpForm.editRecItemQty.$invalid:"withdraw"===n.edittingRec.opType.value||"deposit"===n.edittingRec.opType.value?n.isProcessing||c.accountOpForm.editRecAmount.$invalid:void 0)},n.updateRec=function(){e.close()},n.cancel=function(){e.dismiss("cancel")}}]).component("accRecList",{templateUrl:locals.appRootPath+"common/component/acc-rec-list.html",bindings:{perPage:"@",showAccField:"<",showOperatorField:"<",accRecEditMode:"@",curPage:"=?",account:"=?",filters:"=?",opTypeFilter:"=?",applyDateFilter:"=?",startDateFilter:"=?",endDateFilter:"=?",accountOp:"=?",edittingRec:"=?",isProcessing:"=?",refreshAccRecs:"=?",updateRecFunc:"=?",downloadDWSheetFunc:"=?",getAccRecErrorCB:"&",getAccRecSuccessCB:"&",updateAccRecErrorCB:"&",updateAccRecSuccessCB:"&",deleteAccRecErrorCB:"&",deleteAccRecSuccessCB:"&",getTransErrorCB:"&",getTransSuccessCB:"&",downloadDWSheetSuccessCB:"&",downloadDWSheetErrorCB:"&"},controller:"AccRecListCtrler as ctrler"})}();