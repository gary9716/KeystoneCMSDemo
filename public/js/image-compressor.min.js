/*!
 * Image Compressor v1.0.0
 * https://github.com/xkeshi/image-compressor
 *
 * Copyright (c) 2017-2018 Xkeshi
 * Released under the MIT license
 *
 * Date: 2018-01-15T09:12:33.649Z
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.ImageCompressor=t()}(this,function(){"use strict";var e,t=(function(e){var t,r,n,a,i,o,l;t=window,r=t.HTMLCanvasElement&&t.HTMLCanvasElement.prototype,n=t.Blob&&function(){try{return Boolean(new Blob)}catch(e){return!1}}(),a=n&&t.Uint8Array&&function(){try{return 100===new Blob([new Uint8Array(100)]).size}catch(e){return!1}}(),i=t.BlobBuilder||t.WebKitBlobBuilder||t.MozBlobBuilder||t.MSBlobBuilder,o=/^data:((.*?)(;charset=.*?)?)(;base64)?,/,l=(n||i)&&t.atob&&t.ArrayBuffer&&t.Uint8Array&&function(e){var t,r,l,u,s,c,f,h,m;if(!(t=e.match(o)))throw new Error("invalid data URI");for(r=t[2]?t[1]:"text/plain"+(t[3]||";charset=US-ASCII"),l=!!t[4],u=e.slice(t[0].length),s=l?atob(u):decodeURIComponent(u),c=new ArrayBuffer(s.length),f=new Uint8Array(c),h=0;h<s.length;h+=1)f[h]=s.charCodeAt(h);return n?new Blob([a?f:c],{type:r}):((m=new i).append(c),m.getBlob(r))},t.HTMLCanvasElement&&!r.toBlob&&(r.mozGetAsFile?r.toBlob=function(e,t,n){var a=this;setTimeout(function(){n&&r.toDataURL&&l?e(l(a.toDataURL(t,n))):e(a.mozGetAsFile("blob",t))})}:r.toDataURL&&l&&(r.toBlob=function(e,t,r){var n=this;setTimeout(function(){e(l(n.toDataURL(t,r)))})})),e.exports?e.exports=l:t.dataURLtoBlob=l}(e={exports:{}},e.exports),e.exports),r=Object.prototype.toString,n={checkOrientation:!0,maxWidth:1/0,maxHeight:1/0,minWidth:0,minHeight:0,width:void 0,height:void 0,quality:.8,mimeType:"auto",convertSize:5e6,success:null,error:null},a=/^image\/.+$/;function i(e){return a.test(e)}var o=String.fromCharCode;var l=window.btoa;function u(e){var t=new DataView(e),r=void 0,n=void 0,a=void 0,i=void 0;if(255===t.getUint8(0)&&216===t.getUint8(1))for(var l=t.byteLength,u=2;u<l;){if(255===t.getUint8(u)&&225===t.getUint8(u+1)){a=u;break}u+=1}if(a){var s=a+10;if("Exif"===function(e,t,r){var n="",a=void 0;for(r+=t,a=t;a<r;a+=1)n+=o(e.getUint8(a));return n}(t,a+4,4)){var c=t.getUint16(s);if(((n=18761===c)||19789===c)&&42===t.getUint16(s+2,n)){var f=t.getUint32(s+4,n);f>=8&&(i=s+f)}}}if(i){var h=t.getUint16(i,n),m=void 0,d=void 0;for(d=0;d<h;d+=1)if(m=i+12*d+2,274===t.getUint16(m,n)){m+=8,r=t.getUint16(m,n),t.setUint16(m,1,n);break}}return r}var s=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},c=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),f=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},h=window,m=h.ArrayBuffer,d=h.FileReader,g=window.URL||window.webkitURL,v=/\.\w+$/;return function(){function e(t,r){s(this,e),this.result=null,t&&this.compress(t,r)}return c(e,[{key:"compress",value:function(e,a){var s=this,c=new Image;return a=f({},n,a),m||(a.checkOrientation=!1),new Promise(function(t,n){if((s=e)instanceof Blob||"[object Blob]"===r.call(s)){var s,c=e.type;if(i(c))if(g||d){if(g&&!a.checkOrientation)t(g.createObjectURL(e));else if(d){var h=new d,m=a.checkOrientation&&"image/jpeg"===c;h.onload=function(e){var r=e.target.result;t(m?f({url:function(e,t){var r=new Uint8Array(e),n=r.length,a="",i=void 0;for(i=0;i<n;i+=1)a+=o(r[i]);return"data:"+t+";base64,"+l(a)}(r,c)},function(e){var t=0,r=1,n=1;switch(e){case 2:r=-1;break;case 3:t=-180;break;case 4:n=-1;break;case 5:t=90,n=-1;break;case 6:t=90;break;case 7:t=90,r=-1;break;case 8:t=-90}return{rotate:t,scaleX:r,scaleY:n}}(u(r))):{url:r})},h.onabort=n,h.onerror=n,m?h.readAsArrayBuffer(e):h.readAsDataURL(e)}}else n(new Error("The current browser does not support image compression."));else n(new Error("The first argument must be an image File or Blob object."))}else n(new Error("The first argument must be a File or Blob object."))}).then(function(t){return new Promise(function(r,n){c.onload=function(){return r(f({},t,{naturalWidth:c.naturalWidth,naturalHeight:c.naturalHeight}))},c.onabort=n,c.onerror=n,c.alt=e.name,c.src=t.url})}).then(function(r){var n=r.naturalWidth,o=r.naturalHeight,l=r.rotate,u=void 0===l?0:l,s=r.scaleX,f=void 0===s?1:s,h=r.scaleY,m=void 0===h?1:h;return new Promise(function(r){var l=document.createElement("canvas"),s=l.getContext("2d"),h=n/o,d=Math.max(a.maxWidth,0)||1/0,g=Math.max(a.maxHeight,0)||1/0,v=Math.max(a.minWidth,0)||0,b=Math.max(a.minHeight,0)||0,p=n,w=o;if(d<1/0&&g<1/0?g*h>d?g=d/h:d=g*h:d<1/0?g=d/h:g<1/0&&(d=g*h),v>0&&b>0?b*h>v?b=v/h:v=b*h:v>0?b=v/h:b>0&&(v=b*h),a.width>0)w=(p=a.width)/h;else if(a.height>0){p=(w=a.height)*h}var y=-(p=Math.min(Math.max(p,v),d))/2,U=-(w=Math.min(Math.max(w,b),g))/2,B=p,M=w;if(Math.abs(u)%180==90){var x={width:w,height:p};p=x.width,w=x.height}l.width=p,l.height=w,s.fillStyle="transparent",s.fillRect(0,0,p,w),s.save(),s.translate(p/2,w/2),s.rotate(u*Math.PI/180),s.scale(f,m),s.drawImage(c,Math.floor(y),Math.floor(U),Math.floor(B),Math.floor(M)),s.restore(),i(a.mimeType)||(a.mimeType=e.type),e.size>a.convertSize&&"image/png"===a.mimeType&&(a.mimeType="image/jpeg");var T=function(e){r({naturalWidth:n,naturalHeight:o,result:e})};l.toBlob?l.toBlob(T,a.mimeType,a.quality):T(t(l.toDataURL(a.mimeType,a.quality)))})}).then(function(t){var r=t.naturalWidth,n=t.naturalHeight,o=t.result;if(g&&g.revokeObjectURL(c.src),o)if(o.size>e.size&&!(a.width>r||a.height>n||a.minWidth>r||a.minHeight>n))o=e;else{var l=new Date;o.lastModified=l.getTime(),o.lastModifiedDate=l,o.name=e.name,o.name&&o.type!==e.type&&(o.name=o.name.replace(v,function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=i(e)?e.substr(6):"";return"jpeg"===r&&(r="jpg"),r&&t&&(r="."+r),r}(o.type)))}else o=e;return s.result=o,a.success&&a.success(o),Promise.resolve(o)}).catch(function(e){if(!a.error)throw e;a.error(e)})}}]),e}()});